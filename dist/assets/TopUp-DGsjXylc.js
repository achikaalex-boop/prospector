import{c as h,a as b}from"./paypal-BI0vB7_-.js";import{c as n,e as t,b as u,E as p,x as c,aL as v,aM as y,l as f,t as m,q as g,o as l}from"./index-Dsp5A8uu.js";import{_ as x}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const k={name:"TopUp",data(){return{amount:10,currency:"USD",order:null,approvalLink:null,message:"",showRedirectModal:!1,isLoading:!1}},methods:{presetClass(s){return this.amount===s?"bg-blue-600 text-white":"bg-gray-100 text-gray-800"},selectPreset(s){this.amount=s},goBack(){this.$router.push("/")},async startTopup(){this.message="",this.isLoading=!0;try{const s=Math.round(Number(this.amount||0)*100);if(s<=0){this.message="Montant invalide",this.isLoading=!1;return}let e=null;try{const{data:{session:a}}=await g.auth.getSession();e=a?.user?.id||null}catch{}const d=await b(s,this.currency,`Top-up ${this.amount} ${this.currency}`,e);this.order=d;const i=(d?.links||[]).find(a=>a.rel==="approve");this.approvalLink=i?i.href:null,this.approvalLink||(this.message="Order créé, mais aucun lien d'approbation trouvé."),this.showRedirectModal=!0}catch(s){console.error(s),this.message=`Erreur: ${s?.response?.data?.error||s.message||s}`}finally{this.isLoading=!1}},async capture(){this.message="";try{if(!this.order||!this.order.id)return this.message="Aucune order à capturer.";let s=null;try{const{data:{session:i}}=await g.auth.getSession();s=i?.user?.id||null}catch{}const e=await h(this.order.id,s),d=e?.capture||e;if(this.order=d,this.approvalLink=null,e&&(e.credited||e.deduction_applied)){e.credited?this.message="Paiement capturé et solde crédité avec succès.":this.message="Paiement capturé et frais d'abonnement déduits du solde.";try{window.dispatchEvent(new CustomEvent("balance:updated"))}catch{}if(e.plan_updated)try{window.dispatchEvent(new CustomEvent("plan:updated"))}catch{}}else if(e&&(e.credit_error||e.deduction_error)){const i=e.credit_error||e.deduction_error;this.message="Paiement capturé, mais mise à jour du solde échouée: "+String(i)}else this.message="Paiement capturé, mais le solde n'a pas été mis à jour automatiquement.";this.showRedirectModal=!1,this.$router.push("/pricing")}catch(s){console.error(s),this.message=`Erreur lors de la capture: ${s?.response?.data?.error||s.message||s}`}},openApprovalFromModal(){this.approvalLink&&(window.open(this.approvalLink,"_blank"),this.showRedirectModal=!1)},cancelRedirect(){this.showRedirectModal=!1}}},w={class:"p-6 max-w-lg mx-auto"},C={class:"bg-white shadow rounded-lg p-6"},P={class:"grid grid-cols-4 gap-3 mb-4"},_={class:"mb-4"},M={class:"flex gap-2"},L={class:"flex items-center gap-3"},R={key:0,class:"mt-4 border rounded bg-gray-50 p-3"},S={class:"text-sm text-gray-700"},U={key:0,class:"mt-2"},E=["href"],T={class:"mt-2"},z={key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"},A={class:"bg-white rounded-lg p-6 w-full max-w-md"},D={class:"flex items-center gap-3"},B={key:0,class:"ml-auto text-sm text-gray-600"},O={key:2,class:"mt-4 text-sm text-red-600"};function V(s,e,d,i,a,r){return l(),n("div",w,[t("div",C,[e[16]||(e[16]=t("h2",{class:"text-2xl font-semibold mb-2"},"Ajouter des fonds",-1)),e[17]||(e[17]=t("p",{class:"text-sm text-gray-600 mb-4"},"Choisissez un montant ou entrez un montant personnalisé.",-1)),t("div",P,[t("button",{onClick:e[0]||(e[0]=o=>r.selectPreset(5)),class:p([r.presetClass(5),"py-2 rounded"])},"$5",2),t("button",{onClick:e[1]||(e[1]=o=>r.selectPreset(10)),class:p([r.presetClass(10),"py-2 rounded"])},"$10",2),t("button",{onClick:e[2]||(e[2]=o=>r.selectPreset(25)),class:p([r.presetClass(25),"py-2 rounded"])},"$25",2),t("button",{onClick:e[3]||(e[3]=o=>r.selectPreset(50)),class:p([r.presetClass(50),"py-2 rounded"])},"$50",2)]),t("div",_,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Montant (USD)",-1)),t("div",M,[c(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>a.amount=o),type:"number",min:"1",class:"flex-1 block w-full border rounded px-3 py-2"},null,512),[[v,a.amount,void 0,{number:!0}]]),c(t("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>a.currency=o),class:"border rounded px-2 py-2"},[...e[11]||(e[11]=[t("option",{value:"USD"},"USD",-1)])],512),[[y,a.currency]])])]),t("div",L,[t("button",{onClick:e[6]||(e[6]=(...o)=>r.startTopup&&r.startTopup(...o)),class:"bg-blue-600 text-white px-4 py-2 rounded shadow"},"Payer avec PayPal"),t("button",{onClick:e[7]||(e[7]=(...o)=>r.goBack&&r.goBack(...o)),class:"text-sm text-gray-600"},"Annuler")]),a.order?(l(),n("div",R,[t("div",S,[e[13]||(e[13]=f("Order ID: ",-1)),t("strong",null,m(a.order.id),1)]),a.approvalLink?(l(),n("div",U,[t("a",{href:a.approvalLink,target:"_blank",class:"text-blue-600"},"Ouvrir le lien d'approbation PayPal",8,E)])):u("",!0),t("div",T,[t("button",{onClick:e[8]||(e[8]=(...o)=>r.capture&&r.capture(...o)),class:"bg-green-600 text-white px-3 py-1 rounded"},"J'ai payé — Capturer")])])):u("",!0),a.showRedirectModal?(l(),n("div",z,[t("div",A,[e[14]||(e[14]=t("h3",{class:"text-lg font-semibold mb-2"},"Redirection vers PayPal",-1)),e[15]||(e[15]=t("p",{class:"text-sm text-gray-700 mb-4"},"Vous allez être redirigé vers PayPal pour autoriser le paiement. Une fois approuvé, revenez ici pour finaliser la capture ou utilisez la page de confirmation.",-1)),t("div",D,[t("button",{onClick:e[9]||(e[9]=(...o)=>r.openApprovalFromModal&&r.openApprovalFromModal(...o)),class:"bg-blue-600 text-white px-4 py-2 rounded"},"Ouvrir PayPal"),t("button",{onClick:e[10]||(e[10]=(...o)=>r.cancelRedirect&&r.cancelRedirect(...o)),class:"px-4 py-2 border rounded"},"Annuler"),a.isLoading?(l(),n("div",B,"Chargement...")):u("",!0)])])])):u("",!0),a.message?(l(),n("div",O,m(a.message),1)):u("",!0)])])}const I=x(k,[["render",V],["__scopeId","data-v-300205c4"]]);export{I as default};
