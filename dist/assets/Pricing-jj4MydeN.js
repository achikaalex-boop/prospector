import{a as y}from"./index-B9ygI19o.js";import{c as a,e as n,j as f,F as _,n as x,w as v,b as u,l as m,t as c,D as P,q as h,o as l,E as g}from"./index-Dsp5A8uu.js";import{_ as w}from"./_plugin-vue_export-helper-DlAUqK2U.js";const A={name:"Pricing",components:{Dialog},data(){return{uiPlans:[{slug:"free",name:"Starter",monthly_price:0,per_min_cents:30,concurrency:5,included_minutes:20},{slug:"standard",name:"Standard",monthly_price:19,per_min_cents:30,concurrency:10,included_minutes:200},{slug:"pro",name:"Pro",monthly_price:49,per_min_cents:30,concurrency:20,included_minutes:1e3}],activePlan:null,balanceCents:0,balanceLoading:!0,approvalLink:null,isLoading:!1,estimatorMinutes:{},defaultEstimateMinutes:10,supportEmail:"",supportLoading:!1,showAddonsDialog:!1,selectedPlanForAddons:null}},async created(){await Promise.all([this.fetchPlans(),this.fetchBalance(),this.fetchActivePlan()]),await this.fetchSupportEmail()},mounted(){window.addEventListener("balance:updated",this.fetchBalance),window.addEventListener("plan:updated",this.fetchActivePlan)},unmounted(){window.removeEventListener("balance:updated",this.fetchBalance),window.removeEventListener("plan:updated",this.fetchActivePlan)},methods:{monthlyPriceCents(t){return t==null?0:typeof t.monthly_price=="number"?Math.round(t.monthly_price*100):typeof t.monthly_price_cents=="number"?Math.round(t.monthly_price_cents):0},async fetchPlans(){try{const{data:t,error:e}=await h.from("plans").select("slug,name,monthly_price_cents,per_min_cents,max_concurrency,included_minutes,description,tagline,objective,minutes_expiry_days,card_required,network_priority,soft_limit_percent,has_dedicated_number,has_extra_concurrency");!e&&Array.isArray(t)&&t.length?(this.uiPlans=t.map(s=>({slug:s.slug,name:s.name,monthly_price:(Number(s.monthly_price_cents)||0)/100,monthly_price_cents:Number(s.monthly_price_cents)||0,per_min_cents:Number(s.per_min_cents)||0,concurrency:Number(s.max_concurrency)||Number(s.concurrency)||0,max_concurrency:Number(s.max_concurrency)||0,included_minutes:Number(s.included_minutes)||0,description:s.description||"",tagline:s.tagline||"",objective:s.objective||"",minutes_expiry_days:s.minutes_expiry_days||null,card_required:s.card_required===!0,network_priority:s.network_priority||"standard",soft_limit_percent:s.soft_limit_percent||null,has_dedicated_number:s.has_dedicated_number===!0,has_extra_concurrency:s.has_extra_concurrency===!0})),this.uiPlans.forEach(s=>{this.estimatorMinutes[s.slug]=this.defaultEstimateMinutes})):this.uiPlans.forEach(s=>{this.estimatorMinutes[s.slug]=this.defaultEstimateMinutes})}catch(t){console.error("fetchPlans error",t),this.uiPlans.forEach(e=>{this.estimatorMinutes[e.slug]=this.defaultEstimateMinutes})}},async fetchBalance(){this.balanceLoading=!0;try{let t=null;try{const{data:{session:d}}=await h.auth.getSession();t=d?.user?.id||null}catch{}if(!t){this.balanceCents=0,this.balanceLoading=!1;return}const{data:e,error:s}=await h.from("user_credits").select("amount").eq("user_id",t);if(!s&&Array.isArray(e)){const d=e.reduce((i,o)=>i+(Number(o.amount)||0),0);this.balanceCents=Math.round(d*100)}else this.balanceCents=0}catch(t){console.error("Could not fetch balance",t),this.balanceCents=0}finally{this.balanceLoading=!1}},async fetchActivePlan(){try{let t=null;try{const{data:{session:d}}=await h.auth.getSession();t=d?.user?.id||null}catch{}if(!t)return;const e=await fetch(`/api/user-plan?user_id=${t}`);if(!e.ok)return;const s=await e.json();this.activePlan=s.plan||null}catch{}},async subscribe(t){try{this.isLoading=!0;let e=null;try{const{data:{session:s}}=await h.auth.getSession();e=s?.user?.id||null}catch{}if(this.isPlanActive(t)){this.$toast.add({severity:"info",summary:"Abonnement",detail:"Vous Ãªtes dÃ©jÃ  abonnÃ© Ã  ce plan.",life:4e3});return}this.activePlan&&this.isDowngrade(t)?this.$confirm({message:"Vous changez vers un plan moins avantageux. Cette action peut Ãªtre irrÃ©versible. Voulez-vous continuer ?",header:"Confirmer la modification",icon:"pi pi-exclamation-triangle",accept:async()=>{await this.performSubscribe(t,e)},reject:()=>{}}):await this.performSubscribe(t,e)}catch(e){console.error("subscribe error",e),this.$toast.add({severity:"error",summary:"Erreur",detail:"Erreur lors de la crÃ©ation de la souscription: "+(e?.response?.data?.error||e.message||e),life:8e3})}finally{this.isLoading=!1}},async performSubscribe(t,e){try{const s=Math.round(t.monthly_price*100),o=((await y.post("/api/subscribe",{plan_slug:t.slug,amount_cents:s,user_id:e})).data?.links||[]).find(p=>p.rel==="approve");this.approvalLink=o?o.href:null,this.approvalLink?(s>(this.balanceCents||0)&&this.$toast.add({severity:"warn",summary:"Solde insuffisant",detail:"Votre solde est insuffisant pour ce plan. Vous serez redirigÃ© vers PayPal pour complÃ©ter le paiement.",life:6e3}),window.location.href=this.approvalLink):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'obtenir le lien PayPal d'approbation",life:6e3})}catch(s){throw s}},isPlanActive(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;return e&&e===t.slug}catch{return!1}},isDowngrade(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;if(!e)return!1;const s=this.uiPlans.find(i=>i.slug===e),d=this.uiPlans.find(i=>i.slug===t.slug);return!s||!d?!1:Number(d.monthly_price||0)<Number(s.monthly_price||0)}catch{return!1}},estimateCostCents(t,e){const s=Number(e)||0;return Math.round((Number(t.per_min_cents)||0)*s)},displayMoney(t){return((Number(t)||0)/100).toFixed(2)},needsTopupCents(t,e){const s=Number(e)||0,d=Number(t.included_minutes)||0,i=Math.max(0,s-d),o=this.estimateCostCents(t,i);return Math.max(0,o-this.balanceCents)},async fetchSupportEmail(){this.supportLoading=!0;try{const t=await y.get("/api/app-settings/support-email");this.supportEmail=t.data?.support_email||""}catch{this.supportEmail=""}finally{this.supportLoading=!1}},async openAddons(t){try{let e=null;try{const{data:{session:s}}=await h.auth.getSession();e=s?.user?.id||null}catch{}if(!e){this.$toast.add({severity:"warn",summary:"Connexion requise",detail:"Veuillez vous connecter pour demander un add-on.",life:5e3}),this.$router.push({name:"Login"});return}this.selectedPlanForAddons=t,this.showAddonsDialog=!0}catch(e){console.error("openAddons error",e),this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'ouvrir les add-ons.",life:5e3})}},async requestAddon(t){try{const{data:{session:e}}=await h.auth.getSession(),s=e?.user?.id||"unknown",d=this.selectedPlanForAddons,i=encodeURIComponent(`Demande d'add-on: ${t} pour ${d?.slug||""}`),o=encodeURIComponent(`Utilisateur: ${s}
Plan: ${d?.slug||""}
Add-on: ${t}
Merci.`),p=this.supportEmail&&String(this.supportEmail).length?this.supportEmail:"support@prospector.example";window.location.href=`mailto:${encodeURIComponent(p)}?subject=${i}&body=${o}`,this.$toast.add({severity:"success",summary:"Demande",detail:"Ouverture du client mail pour contacter le support",life:5e3}),this.showAddonsDialog=!1,this.selectedPlanForAddons=null}catch(e){console.error("requestAddon error",e),this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de lancer la demande.",life:5e3})}},closeAddonsDialog(){this.showAddonsDialog=!1,this.selectedPlanForAddons=null}}},k={class:"p-6 max-w-4xl mx-auto"},C={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},E={class:"flex items-start justify-between gap-3"},D={class:"flex items-center gap-2"},L={key:0,class:"text-green-500"},M={key:1,class:"text-blue-500"},N={key:2,class:"text-red-500"},S={class:"text-lg font-semibold"},F={class:"text-xs ml-2 text-gray-500"},j={class:"mt-3 text-sm text-gray-200/80"},q={class:"text-xl font-bold"},V={class:"text-right"},U={key:0,class:"text-xs uppercase px-2 py-1 bg-green-600 text-white rounded"},B={class:"mt-4 text-sm"},I={key:0,class:"mb-2"},z={class:"mt-2 space-y-1"},O={key:0},R={key:0},T={key:1},G={class:"mt-2 space-y-1"},H={class:"mt-2 space-y-1 text-sm text-gray-700"},J={key:0},K={key:1},Q={key:2},W={key:1,class:"mt-3 text-xs text-gray-500"},X={class:"mt-4"},Y={key:0,class:"flex items-center gap-2"},Z=["onClick","disabled"],$=["onClick"],ee={key:1,class:"px-4 py-2 border rounded text-sm text-gray-600"},te={key:0},se={class:"mb-3"},ne={class:"mb-4"},re={key:0},ie={key:1},oe={key:2},ae={class:"flex gap-2"};function le(t,e,s,d,i,o){const p=P("Dialog");return l(),a(_,null,[n("div",k,[e[21]||(e[21]=n("h1",{class:"text-3xl font-bold mb-4"},"Abonnements",-1)),e[22]||(e[22]=n("div",{class:"mb-4 text-sm text-gray-600"},"Choisissez un abonnement adaptÃ© Ã  votre usage. Les appels sont facturÃ©s Ã  la minute en sus si applicable.",-1)),n("div",C,[(l(!0),a(_,null,x(i.uiPlans,r=>(l(),a("div",{key:r.slug,class:g(["p-6 rounded-lg",r.slug==="pro"?"bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg":"bg-white border"])},[n("div",E,[n("div",null,[n("div",D,[r.slug==="free"?(l(),a("span",L,"ðŸŸ¢")):r.slug==="starter"||r.slug==="standard"?(l(),a("span",M,"ðŸ”µ")):r.slug==="pro"?(l(),a("span",N,"ðŸ”´")):u("",!0),n("h3",S,[m(c(r.name)+" ",1),n("span",F,c(r.tagline||""),1)])]),n("div",j,[n("div",q,c(o.displayMoney(o.monthlyPriceCents(r)))+" USD",1),e[5]||(e[5]=n("div",{class:"text-sm text-gray-400"},"/ mois",-1))])]),n("div",V,[i.activePlan&&(i.activePlan.plan_slug===r.slug||i.activePlan.slug===r.slug)?(l(),a("div",U,"Actif")):u("",!0)])]),n("div",B,[r.objective?(l(),a("p",I,[e[6]||(e[6]=n("strong",null,"Objectif :",-1)),m(" "+c(r.objective),1)])):u("",!0),e[18]||(e[18]=n("p",{class:"font-semibold"},"Inclus",-1)),n("ul",z,[n("li",null,[e[7]||(e[7]=n("strong",null,"Prix :",-1)),m(" "+c(o.displayMoney(o.monthlyPriceCents(r)))+" USD",1)]),n("li",null,[e[8]||(e[8]=n("strong",null,"Minutes incluses :",-1)),m(" "+c(r.included_minutes||"â€”")+" / mois ",1),e[9]||(e[9]=n("small",{class:"text-gray-500"},"(non reportables)",-1))]),n("li",null,[e[10]||(e[10]=n("strong",null,"Concurrency :",-1)),m(" "+c(r.max_concurrency||r.concurrency||"â€”"),1)]),r.minutes_expiry_days?(l(),a("li",O,[e[11]||(e[11]=n("strong",null,"Expiration des minutes :",-1)),m(" "+c(r.minutes_expiry_days)+" jours",1)])):u("",!0),n("li",null,[e[12]||(e[12]=n("strong",null,"Carte bancaire requise :",-1)),e[13]||(e[13]=m()),r.card_required?(l(),a("span",R,"âœ…")):(l(),a("span",T,"âŒ"))]),n("li",null,[e[14]||(e[14]=n("strong",null,"PrioritÃ© rÃ©seau :",-1)),m(" "+c(r.network_priority||"standard"),1)]),n("li",null,[e[15]||(e[15]=n("strong",null,"Soft limit :",-1)),m(" "+c(r.soft_limit_percent||"â€”")+"%",1)]),e[16]||(e[16]=n("li",null,"Throttling aprÃ¨s dÃ©passement",-1))]),e[19]||(e[19]=n("p",{class:"mt-3 font-semibold"},"Au-delÃ ",-1)),n("ul",G,[n("li",null,[e[17]||(e[17]=n("strong",null,"Facturation :",-1)),m(" "+c(o.displayMoney(r.per_min_cents||0))+" USD / minute",1)])]),e[20]||(e[20]=n("p",{class:"mt-3 font-semibold"},"Options",-1)),n("ul",H,[r.has_dedicated_number?(l(),a("li",J,"NumÃ©ro dÃ©diÃ© sur demande (add-on)")):u("",!0),r.has_extra_concurrency?(l(),a("li",K,"Concurrency supplÃ©mentaire (add-on)")):u("",!0),r.has_dedicated_number?u("",!0):(l(),a("li",Q,"Pas de numÃ©ro dÃ©diÃ©"))]),r.description?(l(),a("p",W,c(r.description),1)):u("",!0)]),n("div",X,[r.slug!=="free"?(l(),a("div",Y,[n("button",{onClick:b=>o.subscribe(r),disabled:o.isPlanActive(r)||i.isLoading,class:g((r.slug==="pro"?"bg-white text-blue-700 px-4 py-2 rounded":"bg-blue-600 text-white px-4 py-2 rounded")+(o.isPlanActive(r)||i.isLoading?" opacity-50 cursor-not-allowed":""))},c(o.isPlanActive(r)?"AbonnÃ©":"S'abonner"),11,Z),r.slug!=="free"?(l(),a("button",{key:0,onClick:b=>o.openAddons(r),class:"px-3 py-2 border rounded text-sm"},"Add-ons",8,$)):u("",!0)])):(l(),a("span",ee,"Plan gratuit"))])],2))),128))])]),f(p,{visible:i.showAddonsDialog,"onUpdate:visible":e[4]||(e[4]=r=>i.showAddonsDialog=r),modal:!0,style:{width:"480px"},header:"Add-ons"},{default:v(()=>[i.selectedPlanForAddons?(l(),a("div",te,[n("p",se,[e[23]||(e[23]=n("strong",null,"Add-ons pour:",-1)),m(" "+c(i.selectedPlanForAddons.name)+" ("+c(i.selectedPlanForAddons.slug)+")",1)]),n("ul",ne,[i.selectedPlanForAddons.has_dedicated_number?(l(),a("li",re,"NumÃ©ro dÃ©diÃ© disponible")):u("",!0),i.selectedPlanForAddons.has_extra_concurrency?(l(),a("li",ie,"Concurrency supplÃ©mentaire disponible")):u("",!0),!i.selectedPlanForAddons.has_dedicated_number&&!i.selectedPlanForAddons.has_extra_concurrency?(l(),a("li",oe,"Aucun add-on disponible pour ce plan.")):u("",!0)]),n("div",ae,[i.selectedPlanForAddons.has_dedicated_number?(l(),a("button",{key:0,onClick:e[0]||(e[0]=r=>o.requestAddon("dedicated_number")),class:"px-3 py-2 bg-blue-600 text-white rounded"},"Demander un numÃ©ro dÃ©diÃ©")):u("",!0),i.selectedPlanForAddons.has_extra_concurrency?(l(),a("button",{key:1,onClick:e[1]||(e[1]=r=>o.requestAddon("extra_concurrency")),class:"px-3 py-2 bg-blue-600 text-white rounded"},"Demander plus de concurrency")):u("",!0),n("button",{onClick:e[2]||(e[2]=r=>o.requestAddon("support")),class:"px-3 py-2 border rounded"},"Contacter le support"),n("button",{onClick:e[3]||(e[3]=(...r)=>o.closeAddonsDialog&&o.closeAddonsDialog(...r)),class:"px-3 py-2 border rounded"},"Fermer")])])):u("",!0)]),_:1},8,["visible"])],64)}const me=w(A,[["render",le]]);export{me as default};
