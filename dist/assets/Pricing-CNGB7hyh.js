import{a as g}from"./index-B9ygI19o.js";import{c as l,e as r,F as f,n as p,q as h,o,E as y,b as m,l as d,t as c}from"./index-DUwdhvDD.js";import{_ as v}from"./_plugin-vue_export-helper-DlAUqK2U.js";const x={name:"Pricing",data(){return{uiPlans:[{slug:"free",name:"Starter",monthly_price:0,per_min_cents:30,concurrency:5,included_minutes:20},{slug:"standard",name:"Standard",monthly_price:19,per_min_cents:30,concurrency:10,included_minutes:200},{slug:"pro",name:"Pro",monthly_price:49,per_min_cents:30,concurrency:20,included_minutes:1e3}],activePlan:null,balanceCents:0,balanceLoading:!0,approvalLink:null,isLoading:!1,estimatorMinutes:{},defaultEstimateMinutes:10}},async created(){await Promise.all([this.fetchPlans(),this.fetchBalance(),this.fetchActivePlan()])},mounted(){window.addEventListener("balance:updated",this.fetchBalance),window.addEventListener("plan:updated",this.fetchActivePlan)},unmounted(){window.removeEventListener("balance:updated",this.fetchBalance),window.removeEventListener("plan:updated",this.fetchActivePlan)},methods:{monthlyPriceCents(t){return t==null?0:typeof t.monthly_price=="number"?Math.round(t.monthly_price*100):typeof t.monthly_price_cents=="number"?Math.round(t.monthly_price_cents):0},formatDescription(t){return t?String(t).split(/[.;\n]+/).map(e=>e.trim()).filter(Boolean):[]},async fetchPlans(){try{const{data:t,error:e}=await h.from("plans").select("slug,name,monthly_price_cents,per_min_cents,max_concurrency,included_minutes,description,tagline,objective,minutes_expiry_days,card_required,network_priority,soft_limit_percent,has_dedicated_number,has_extra_concurrency");!e&&Array.isArray(t)&&t.length?(this.uiPlans=t.map(n=>({slug:n.slug,name:n.name,monthly_price:(Number(n.monthly_price_cents)||0)/100,monthly_price_cents:Number(n.monthly_price_cents)||0,per_min_cents:Number(n.per_min_cents)||0,concurrency:Number(n.max_concurrency)||Number(n.concurrency)||0,max_concurrency:Number(n.max_concurrency)||0,included_minutes:Number(n.included_minutes)||0,description:n.description||"",tagline:n.tagline||"",objective:n.objective||"",minutes_expiry_days:n.minutes_expiry_days||null,card_required:n.card_required===!0,network_priority:n.network_priority||"standard",soft_limit_percent:n.soft_limit_percent||null,has_dedicated_number:n.has_dedicated_number===!0,has_extra_concurrency:n.has_extra_concurrency===!0})),this.uiPlans.forEach(n=>{this.estimatorMinutes[n.slug]=this.defaultEstimateMinutes})):this.uiPlans.forEach(n=>{this.estimatorMinutes[n.slug]=this.defaultEstimateMinutes})}catch(t){console.error("fetchPlans error",t),this.uiPlans.forEach(e=>{this.estimatorMinutes[e.slug]=this.defaultEstimateMinutes})}},async fetchBalance(){this.balanceLoading=!0;try{let t=null;try{const{data:{session:u}}=await h.auth.getSession();t=u?.user?.id||null}catch{}if(!t){this.balanceCents=0,this.balanceLoading=!1;return}const{data:e,error:n}=await h.from("user_credits").select("amount").eq("user_id",t);if(!n&&Array.isArray(e)){const u=e.reduce((a,i)=>a+(Number(i.amount)||0),0);this.balanceCents=Math.round(u*100)}else this.balanceCents=0}catch(t){console.error("Could not fetch balance",t),this.balanceCents=0}finally{this.balanceLoading=!1}},async fetchActivePlan(){try{let t=null;try{const{data:{session:u}}=await h.auth.getSession();t=u?.user?.id||null}catch{}if(!t)return;const e=await fetch(`/api/user-plan?user_id=${t}`);if(!e.ok)return;const n=await e.json();this.activePlan=n.plan||null}catch{}},async subscribe(t){try{this.isLoading=!0;let e=null;try{const{data:{session:n}}=await h.auth.getSession();e=n?.user?.id||null}catch{}if(this.isPlanActive(t)){this.$toast.add({severity:"info",summary:"Abonnement",detail:"Vous √™tes d√©j√† abonn√© √† ce plan.",life:4e3});return}this.activePlan&&this.isDowngrade(t)?this.$confirm({message:"Vous changez vers un plan moins avantageux. Cette action peut √™tre irr√©versible. Voulez-vous continuer ?",header:"Confirmer la modification",icon:"pi pi-exclamation-triangle",accept:async()=>{await this.performSubscribe(t,e)},reject:()=>{}}):await this.performSubscribe(t,e)}catch(e){console.error("subscribe error",e),this.$toast.add({severity:"error",summary:"Erreur",detail:"Erreur lors de la cr√©ation de la souscription: "+(e?.response?.data?.error||e.message||e),life:8e3})}finally{this.isLoading=!1}},async performSubscribe(t,e){try{const n=Math.round(t.monthly_price*100),i=((await g.post("/api/subscribe",{plan_slug:t.slug,amount_cents:n,user_id:e})).data?.links||[]).find(s=>s.rel==="approve");if(this.approvalLink=i?i.href:null,n===0)try{if(!e){this.$toast.add({severity:"warn",summary:"Connexion requise",detail:"Veuillez vous connecter pour changer de plan.",life:4e3}),this.$router.push({name:"Login"});return}const s=await g.post("/api/change-plan",{user_id:e,plan_slug:t.slug});if(s&&s.status>=200&&s.status<300){this.$toast.add({severity:"success",summary:"Abonnement",detail:`Vous √™tes maintenant sur le plan ${t.name}.`,life:4e3}),await this.fetchActivePlan();return}else{this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de changer de plan.",life:6e3});return}}catch(s){console.error("change-plan error",s),this.$toast.add({severity:"error",summary:"Erreur",detail:s?.response?.data?.error||s.message||String(s),life:8e3});return}this.approvalLink?n>(this.balanceCents||0)?(this.$toast.add({severity:"warn",summary:"Solde insuffisant",detail:"Votre solde est insuffisant pour ce plan. Vous serez redirig√© vers PayPal pour compl√©ter le paiement.",life:6e3}),setTimeout(()=>{window.location.href=this.approvalLink},700)):window.location.href=this.approvalLink:this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'obtenir le lien PayPal d'approbation",life:6e3})}catch(n){throw n}},isPlanActive(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;return e&&e===t.slug}catch{return!1}},isDowngrade(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;if(!e)return!1;const n=this.uiPlans.find(a=>a.slug===e),u=this.uiPlans.find(a=>a.slug===t.slug);return!n||!u?!1:Number(u.monthly_price||0)<Number(n.monthly_price||0)}catch{return!1}},estimateCostCents(t,e){const n=Number(e)||0;return Math.round((Number(t.per_min_cents)||0)*n)},displayMoney(t){return((Number(t)||0)/100).toFixed(2)},needsTopupCents(t,e){const n=Number(e)||0,u=Number(t.included_minutes)||0,a=Math.max(0,n-u),i=this.estimateCostCents(t,a);return Math.max(0,i-this.balanceCents)}}},P={class:"p-6 max-w-4xl mx-auto"},w={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},k={class:"flex items-start justify-between gap-3"},C={class:"flex items-center gap-2"},A={key:0,class:"text-green-500"},L={key:1,class:"text-blue-500"},M={key:2,class:"text-red-500"},E={class:"text-lg font-semibold"},N={class:"text-xs ml-2 text-gray-500"},S={class:"mt-3 text-sm text-gray-200/80"},j={class:"text-right"},V={key:0,class:"text-xs uppercase px-2 py-1 bg-green-600 text-white rounded"},B={class:"mt-4 text-sm"},D={key:0,class:"mb-2"},q={class:"mt-2 space-y-1"},z={key:0},F={class:"mt-2 space-y-1"},T={class:"mt-2 space-y-1 text-sm text-gray-700"},I={key:0},U={key:1},O={key:2},$={key:1,class:"mt-3 text-xs text-gray-500"},G={class:"list-disc ml-4 space-y-1"},H={class:"mt-4"},J={class:"flex items-center gap-2"},K=["onClick","disabled"];function Q(t,e,n,u,a,i){return o(),l("div",P,[e[14]||(e[14]=r("h1",{class:"text-3xl font-bold mb-4"},"Abonnements",-1)),e[15]||(e[15]=r("div",{class:"mb-4 text-sm text-gray-600"},"Choisissez un abonnement adapt√© √† votre usage. Les appels sont factur√©s √† la minute en sus si applicable.",-1)),r("div",w,[(o(!0),l(f,null,p(a.uiPlans,s=>(o(),l("div",{key:s.slug,class:y(["p-6 rounded-lg",s.slug==="pro"?"bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg":"bg-white border"])},[r("div",k,[r("div",null,[r("div",C,[s.slug==="free"?(o(),l("span",A,"üü¢")):s.slug==="starter"||s.slug==="standard"?(o(),l("span",L,"üîµ")):s.slug==="pro"?(o(),l("span",M,"üî¥")):m("",!0),r("h3",E,[d(c(s.name)+" ",1),r("span",N,c(s.tagline||""),1)])]),r("div",S,[r("div",{class:y(["text-xl font-bold",s.slug==="pro"?"text-white":"text-gray-900"])},c(i.displayMoney(i.monthlyPriceCents(s)))+" USD",3),e[0]||(e[0]=r("div",{class:"text-sm text-gray-400"},"/ mois",-1))])]),r("div",j,[a.activePlan&&(a.activePlan.plan_slug===s.slug||a.activePlan.slug===s.slug)?(o(),l("div",V,"Actif")):m("",!0)])]),r("div",B,[s.objective?(o(),l("p",D,[e[1]||(e[1]=r("strong",null,"Objectif :",-1)),d(" "+c(s.objective),1)])):m("",!0),e[11]||(e[11]=r("p",{class:"font-semibold"},"Inclus",-1)),r("ul",q,[r("li",null,[e[2]||(e[2]=r("strong",null,"Prix :",-1)),d(" "+c(i.displayMoney(i.monthlyPriceCents(s)))+" USD",1)]),r("li",null,[e[3]||(e[3]=r("strong",null,"Minutes incluses :",-1)),d(" "+c(s.included_minutes||"‚Äî")+" / mois",1)]),r("li",null,[e[4]||(e[4]=r("strong",null,"Concurrency :",-1)),d(" "+c(s.max_concurrency||s.concurrency||"‚Äî"),1)]),s.minutes_expiry_days?(o(),l("li",z,[e[5]||(e[5]=r("strong",null,"Expiration des minutes :",-1)),d(" "+c(s.minutes_expiry_days)+" jours",1)])):m("",!0),r("li",null,[e[6]||(e[6]=r("strong",null,"Priorit√© r√©seau :",-1)),d(" "+c(s.network_priority||"standard"),1)]),r("li",null,[e[7]||(e[7]=r("strong",null,"Soft limit :",-1)),d(" "+c(s.soft_limit_percent||"‚Äî")+"% ",1),e[8]||(e[8]=r("small",{class:"text-gray-500"},"Seuil d'alerte : d√©clenche avertissements et mesures d'att√©nuation avant facturation additionnelle.",-1))]),e[9]||(e[9]=r("li",null,[d("Throttling apr√®s d√©passement "),r("small",{class:"text-gray-500"},"Apr√®s d√©passement des minutes incluses, le d√©bit est r√©duit temporairement pour limiter les co√ªts.")],-1))]),e[12]||(e[12]=r("p",{class:"mt-3 font-semibold"},"Au-del√†",-1)),r("ul",F,[r("li",null,[e[10]||(e[10]=r("strong",null,"Facturation :",-1)),d(" "+c(i.displayMoney(s.per_min_cents||0))+" USD / minute",1)])]),e[13]||(e[13]=r("p",{class:"mt-3 font-semibold"},"Options",-1)),r("ul",T,[s.has_dedicated_number?(o(),l("li",I,"Num√©ro d√©di√© sur demande (add-on)")):m("",!0),s.has_extra_concurrency?(o(),l("li",U,"Concurrency suppl√©mentaire (add-on)")):m("",!0),s.has_dedicated_number?m("",!0):(o(),l("li",O,"Pas de num√©ro d√©di√©"))]),s.description?(o(),l("div",$,[r("ul",G,[(o(!0),l(f,null,p(i.formatDescription(s.description),(_,b)=>(o(),l("li",{key:b},c(_),1))),128))])])):m("",!0)]),r("div",H,[r("div",J,[r("button",{onClick:_=>i.subscribe(s),disabled:i.isPlanActive(s)||a.isLoading,class:y((s.slug==="pro"?"bg-white text-blue-700 px-4 py-2 rounded":s.slug==="free"?"bg-gray-100 text-gray-800 px-4 py-2 rounded":"bg-blue-600 text-white px-4 py-2 rounded")+(i.isPlanActive(s)||a.isLoading?" opacity-50 cursor-not-allowed":""))},c(i.isPlanActive(s)?"Abonn√©":s.slug==="free"?"Passer au gratuit":"S'abonner"),11,K)])])],2))),128))])])}const Y=v(x,[["render",Q]]);export{Y as default};
