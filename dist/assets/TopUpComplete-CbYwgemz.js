import{c as y}from"./paypal-BI0vB7_-.js";import{c as i,e as r,aN as f,b as m,l as v,t as u,I as g,q as h,o as n}from"./index-4MemwKCE.js";import{_ as w}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const x={name:"TopUpComplete",data(){return{loading:!0,success:!1,message:""}},async created(){const s=g();try{const e=new URLSearchParams(window.location.search),l=e.get("token")||e.get("orderID")||null,p=e.get("plan_slug")||null;if(!l)throw new Error("No token/order id in query");let o=null;try{const{data:{session:t}}=await h.auth.getSession();o=t?.user?.id||null}catch{}try{const t=await y(l,o,p),d=t?.capture||t;if(t&&(t.credited||t.deduction_applied)){this.success=!0,t.credited?s.add({severity:"success",summary:"Paiement",detail:"Paiement capturé et solde crédité",life:6e3}):s.add({severity:"success",summary:"Paiement",detail:"Paiement capturé et frais d'abonnement déduits du solde",life:6e3});try{window.dispatchEvent(new CustomEvent("balance:updated"))}catch{}if(t.plan_updated)try{window.dispatchEvent(new CustomEvent("plan:updated"))}catch{}}else if(t&&(t.credit_error||t.deduction_error)){this.success=!0;const a=t.credit_error||t.deduction_error;s.add({severity:"warn",summary:"Paiement",detail:"Paiement capturé, mais le solde n'a pas pu être mis à jour: "+String(a),life:8e3}),this.message=String(a)}else this.success=!0,s.add({severity:"warn",summary:"Paiement",detail:"Paiement capturé, mais le solde n'a pas été modifié automatiquement",life:8e3})}catch(t){const d=t?.response?.status,a=t?.response?.data||{};if(d===409&&a.approval_link){s.add({severity:"warn",summary:"Autorisation requise",detail:"Le paiement n'a pas été approuvé. Veuillez autoriser le paiement sur PayPal.",life:1e4});try{window.open(a.approval_link,"_blank")}catch{}}else{const c=a.error||t.message||String(t);s.add({severity:"error",summary:"Erreur paiement",detail:c,life:8e3}),this.message=c}}}catch(e){console.error("TopUpComplete error",e),this.message=e?.response?.data?.error||e.message||String(e);try{g().add({severity:"error",summary:"Erreur",detail:this.message,life:8e3})}catch{}}finally{this.loading=!1}}},b={class:"p-6 max-w-md mx-auto"},k={class:"bg-white rounded-lg shadow p-6 text-center"},_={key:0,class:"flex flex-col items-center gap-4"},C={key:1,class:"flex flex-col items-center gap-4"},P={key:0,class:"text-lg"},E={key:1,class:"text-sm text-gray-500"},S={class:"flex gap-3 mt-4"},N={key:2,class:"text-center"},$={class:"mt-2 text-sm text-gray-700"},T={class:"mt-4"};function V(s,e,l,p,o,t){return n(),i("div",b,[r("div",k,[o.loading?(n(),i("div",_,[...e[3]||(e[3]=[f('<svg class="animate-spin h-10 w-10 text-blue-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg><div class="text-lg font-medium">Traitement du paiement...</div><div class="text-sm text-gray-500">Ne fermez pas cette page. Vous serez redirigé automatiquement.</div>',3)])])):o.success?(n(),i("div",C,[e[5]||(e[5]=r("div",{class:"rounded-full bg-green-100 p-3"},[r("svg",{class:"h-10 w-10 text-green-600",viewBox:"0 0 20 20",fill:"currentColor"},[r("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-7.071 7.071a1 1 0 01-1.414 0L3.293 9.95a1 1 0 011.414-1.414L8 11.828l6.293-6.293a1 1 0 011.414 0z","clip-rule":"evenodd"})])],-1)),e[6]||(e[6]=r("h2",{class:"text-2xl font-semibold"},"Paiement capturé ✅",-1)),s.captureAmount?(n(),i("div",P,[e[4]||(e[4]=v("Montant crédité : ",-1)),r("strong",null,u(s.captureAmount)+" "+u(s.captureCurrency||"USD"),1)])):m("",!0),s.orderId?(n(),i("div",E,"Référence : "+u(s.orderId),1)):m("",!0),r("div",S,[r("button",{onClick:e[0]||(e[0]=d=>s.$router.push("/pricing")),class:"px-4 py-2 bg-blue-600 text-white rounded"},"Retour au Pricing"),r("button",{onClick:e[1]||(e[1]=d=>s.$router.push("/")),class:"px-4 py-2 border rounded"},"Dashboard")])])):(n(),i("div",N,[e[7]||(e[7]=r("h2",{class:"text-xl font-semibold text-red-600"},"Erreur lors du paiement",-1)),r("p",$,u(o.message),1),r("div",T,[r("button",{onClick:e[2]||(e[2]=d=>s.$router.push("/topup")),class:"px-4 py-2 bg-blue-600 text-white rounded"},"Réessayer")])]))])])}const I=w(x,[["render",V]]);export{I as default};
