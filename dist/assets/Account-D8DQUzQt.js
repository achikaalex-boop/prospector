import{c as i,e,b as _,t as d,F as h,n as m,q as u,o,E as f}from"./index-Dsp5A8uu.js";import{_ as y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const g={name:"Account",data(){return{plan:null,balanceCents:0,balanceLoading:!0,transactions:[],loadingTransactions:!0,addons:[]}},computed:{planLabel(){return this.plan?this.plan.plan_slug||this.plan.slug||"Starter":"Starter (par défaut)"},planExpired(){try{return!this.plan||!this.plan.expires_at?!1:new Date(this.plan.expires_at)<=new Date}catch{return!1}}},async created(){await Promise.all([this.fetchPlan(),this.fetchBalance(),this.fetchTransactions(),this.fetchAddons()])},methods:{formatDate(a){try{return new Date(a).toLocaleString()}catch{return a}},displayMoney(a){return((Number(a)||0)/100).toFixed(2)},async fetchPlan(){try{const{data:{session:a}}=await u.auth.getSession(),s=a?.user?.id||null;if(!s)return;const{data:c,error:l}=await u.from("user_plans").select("*").eq("user_id",s).order("started_at",{ascending:!1}).limit(1).single();!l&&c&&(this.plan=c)}catch(a){console.error("fetchPlan error",a)}},async fetchBalance(){this.balanceLoading=!0;try{const{data:{session:a}}=await u.auth.getSession(),s=a?.user?.id||null;if(!s){this.balanceCents=0,this.balanceLoading=!1;return}const{data:c,error:l}=await u.from("user_credits").select("amount").eq("user_id",s);if(!l&&Array.isArray(c)){const n=c.reduce((t,r)=>t+(Number(r.amount)||0),0);this.balanceCents=Math.round(n*100)}else this.balanceCents=0}catch(a){console.error("fetchBalance error",a),this.balanceCents=0}finally{this.balanceLoading=!1}},async fetchTransactions(){this.loadingTransactions=!0;try{const{data:{session:a}}=await u.auth.getSession(),s=a?.user?.id||null;if(!s)return;const{data:c}=await u.from("user_credits").select("id,amount,currency,source,meta,created_at").eq("user_id",s).order("created_at",{ascending:!1}).limit(50),{data:l}=await u.from("billing_transactions").select("id,amount_cents,currency,status,meta,created_at").eq("user_id",s).order("created_at",{ascending:!1}).limit(20),n=[];Array.isArray(c)&&c.forEach(t=>n.push({id:t.id,amount:Number(t.amount),currency:t.currency,source:t.source,description:t.source,created_at:t.created_at})),Array.isArray(l)&&l.forEach(t=>n.push({id:t.id,amount:t.amount_cents?Number(t.amount_cents)/100:0,currency:t.currency,source:"billing",description:t.status||"billing",created_at:t.created_at})),n.sort((t,r)=>new Date(r.created_at)-new Date(t.created_at)),this.transactions=n.slice(0,50)}catch(a){console.error("fetchTransactions error",a)}finally{this.loadingTransactions=!1}},async fetchAddons(){try{const{data:{session:a}}=await u.auth.getSession(),s=a?.user?.id||null;if(!s)return;const{data:c,error:l}=await u.from("user_addons").select("addon_key,value,created_at").eq("user_id",s);!l&&Array.isArray(c)&&(this.addons=c)}catch(a){console.error("fetchAddons error",a)}},goToPricing(){this.$router.push("/pricing")}}},p={class:"p-6 max-w-3xl mx-auto"},b={class:"bg-white p-4 rounded shadow mb-4"},x={class:"flex items-center justify-between"},v={class:"text-lg font-semibold"},w={key:0,class:"text-sm text-gray-500"},k={key:1,class:"text-sm text-gray-500"},A={key:2,class:"text-sm text-red-600"},D={class:"text-right"},S={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},C={class:"bg-white p-4 rounded shadow"},T={key:0},L={key:1,class:"text-lg font-bold"},E={class:"bg-white p-4 rounded shadow"},P={key:0},q={key:1},N={class:"text-sm"},B={class:"flex justify-between"},M={class:"font-medium"},I={class:"text-gray-500 text-xs"},j={class:"text-right"},F={class:"text-xs text-gray-500"},U={key:0,class:"text-sm text-gray-500"},V={class:"mt-4 bg-white p-4 rounded shadow max-w-3xl mx-auto"},z={key:0,class:"text-sm text-gray-500"},H={key:1,class:"text-sm"},J={class:"flex justify-between"},O={class:"font-medium"},G={class:"text-xs text-gray-500"},K={class:"text-sm text-gray-700"};function Q(a,s,c,l,n,t){return o(),i("div",p,[s[5]||(s[5]=e("h1",{class:"text-2xl font-bold mb-4"},"Mon compte — Abonnement",-1)),e("div",b,[e("div",x,[e("div",null,[s[1]||(s[1]=e("div",{class:"text-sm text-gray-600"},"Plan actuel",-1)),e("div",v,d(t.planLabel),1),n.plan&&n.plan.started_at?(o(),i("div",w,"Commencé: "+d(t.formatDate(n.plan.started_at)),1)):_("",!0),n.plan&&n.plan.expires_at?(o(),i("div",k,"Expire: "+d(t.formatDate(n.plan.expires_at)),1)):_("",!0),t.planExpired?(o(),i("div",A,"Expiré — vous êtes sur Starter")):_("",!0)]),e("div",D,[e("button",{onClick:s[0]||(s[0]=(...r)=>t.goToPricing&&t.goToPricing(...r)),class:"bg-blue-600 text-white px-4 py-2 rounded"},"Changer le plan")])])]),e("div",S,[e("div",C,[s[2]||(s[2]=e("h3",{class:"font-semibold mb-2"},"Solde",-1)),n.balanceLoading?(o(),i("div",T,"Chargement...")):(o(),i("div",L,d(t.displayMoney(n.balanceCents))+" USD",1))]),e("div",E,[s[3]||(s[3]=e("h3",{class:"font-semibold mb-2"},"Historique des paiements",-1)),n.loadingTransactions?(o(),i("div",P,"Chargement...")):(o(),i("div",q,[e("ul",N,[(o(!0),i(h,null,m(n.transactions,r=>(o(),i("li",{key:r.id,class:"py-2 border-b"},[e("div",B,[e("div",null,[e("div",M,d(r.description||r.source||"Transaction"),1),e("div",I,d(t.formatDate(r.created_at)),1)]),e("div",j,[e("div",{class:f(r.amount<0?"text-red-600":"text-green-600")},d(r.amount<0?"-":"+")+d(t.displayMoney(Math.abs(r.amount*100)))+" USD",3),e("div",F,d(r.currency||"USD"),1)])])]))),128))]),n.transactions.length===0?(o(),i("div",U,"Aucune transaction récente.")):_("",!0)]))])]),e("div",V,[s[4]||(s[4]=e("h3",{class:"font-semibold mb-2"},"Add-ons activés",-1)),n.addons.length===0?(o(),i("div",z,"Aucun add-on activé.")):(o(),i("ul",H,[(o(!0),i(h,null,m(n.addons,r=>(o(),i("li",{key:r.addon_key,class:"py-2 border-b"},[e("div",J,[e("div",null,[e("div",O,d(r.addon_key),1),e("div",G,"Activé: "+d(t.formatDate(r.created_at)),1)]),e("div",K,d(r.value?JSON.stringify(r.value):""),1)])]))),128))]))])])}const X=y(g,[["render",Q]]);export{X as default};
