import{a as o}from"./index-B9ygI19o.js";import{c as p,e as t,x as n,aL as l,aM as b,l as y,F as h,n as f,q as v,o as c,t as g}from"./index-Dsp5A8uu.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";const x={name:"AdminPlans",data(){return{plans:[],loading:!0,editable:{},supportEmail:"",supportLoading:!1,adminEmailInput:"",adminPasswordInput:""}},async created(){try{const s=localStorage.getItem("admin_token"),e=s?{"x-admin-token":s}:{},r=await o.get("/api/admin/check",{headers:e});if(!r.data||!r.data.ok){this.$toast.add({severity:"warn",summary:"Accès refusé",detail:"Accès administrateur requis",life:4e3}),this.$router.push("/admin");return}s&&(o.defaults.headers.common["x-admin-token"]=s)}catch{this.$toast.add({severity:"warn",summary:"Accès refusé",detail:"Accès administrateur requis",life:4e3}),this.$router.push("/admin");return}await this.load(),this.addonForm={user_id:"",addon_key:"dedicated_number",value:""},await this.fetchSupportEmail()},methods:{async load(){this.loading=!0;try{const{data:s,error:e}=await v.from("plans").select("*").order("monthly_price_cents",{ascending:!0});!e&&Array.isArray(s)&&(this.plans=s,s.forEach(r=>{this.editable[r.slug]={monthly_price:(r.monthly_price_cents||0)/100,included_minutes:r.included_minutes||0,per_min_cents:r.per_min_cents||0}}))}catch(s){console.error(s)}finally{this.loading=!1}},reset(s){if(this.plans){const e=this.plans.find(r=>r.slug===s);e&&(this.editable[s]={monthly_price:(e.monthly_price_cents||0)/100,included_minutes:e.included_minutes||0,per_min_cents:e.per_min_cents||0})}},async save(s){try{const e=this.editable[s],r={slug:s,monthly_price_cents:Math.round(Number(e.monthly_price||0)*100),included_minutes:Number(e.included_minutes||0),per_min_cents:Number(e.per_min_cents||0)},m=await o.post("/api/admin/plan-upsert",r);m.data&&m.data.ok?(this.$toast.add({severity:"success",summary:"Enregistré",detail:"Plan mis à jour",life:4e3}),await this.load()):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour le plan",life:6e3})}catch(e){console.error(e),this.$toast.add({severity:"error",summary:"Erreur",detail:e?.response?.data?.error||e.message||String(e),life:8e3})}},async grantAddon(){try{const s=localStorage.getItem("admin_token"),e=s?{"x-admin-token":s}:{},r={user_id:this.addonForm.user_id,addon_key:this.addonForm.addon_key,value:this.addonForm.value?JSON.parse(this.addonForm.value):null},m=await o.post("/api/admin/grant-addon",r,{headers:e});m.data&&m.data.ok?(this.$toast.add({severity:"success",summary:"OK",detail:"Add-on accordé",life:4e3}),this.addonForm={user_id:"",addon_key:"dedicated_number",value:""}):this.$toast.add({severity:"error",summary:"Erreur",detail:"Échec",life:6e3})}catch(s){console.error(s),this.$toast.add({severity:"error",summary:"Erreur",detail:s?.response?.data?.error||s.message||String(s),life:8e3})}},async fetchSupportEmail(){this.supportLoading=!0;try{const s=await o.get("/api/app-settings/support-email");this.supportEmail=s.data?.support_email||""}catch(s){console.error("fetchSupportEmail failed",s),this.supportEmail=""}finally{this.supportLoading=!1}},async saveAdminCredentials(){try{const s=localStorage.getItem("admin_token"),e=s?{"x-admin-token":s}:{},r=await o.post("/api/admin/set-admin-credentials",{email:this.adminEmailInput,password:this.adminPasswordInput},{headers:e});r.data&&r.data.ok?this.$toast.add({severity:"success",summary:"Enregistré",detail:"Identifiants admin mis à jour",life:4e3}):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour",life:6e3})}catch(s){console.error("saveAdminCredentials failed",s),this.$toast.add({severity:"error",summary:"Erreur",detail:s?.response?.data?.error||s.message||String(s),life:8e3})}},clearAdminToken(){localStorage.removeItem("admin_token"),delete o.defaults.headers.common["x-admin-token"],this.$toast.add({severity:"info",summary:"Déconnecté",detail:"Session admin déconnectée localement",life:3e3})},async saveSupportEmail(){try{const s=localStorage.getItem("admin_token"),e=s?{"x-admin-token":s}:{},r=await o.post("/api/admin/app-settings",{key:"support_email",value:this.supportEmail},{headers:e});r.data&&r.data.ok?this.$toast.add({severity:"success",summary:"Enregistré",detail:"Email de support mis à jour",life:4e3}):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'enregistrer",life:6e3})}catch(s){console.error("saveSupportEmail failed",s),this.$toast.add({severity:"error",summary:"Erreur",detail:s?.response?.data?.error||s.message||String(s),life:8e3})}}}},k={class:"p-6 max-w-4xl mx-auto"},w={key:0},E={key:1},A={class:"mb-4 bg-white p-4 rounded shadow"},S={class:"grid grid-cols-3 gap-2"},I={class:"mt-2"},C={class:"mb-4 bg-white p-4 rounded shadow"},F={class:"flex gap-2"},V={class:"mb-4 bg-white p-4 rounded shadow"},U={class:"flex gap-2 mt-2"},P=["disabled"],j={class:"flex justify-between items-start"},L={class:"text-lg font-semibold"},N={class:"text-sm text-gray-500"},D={class:"text-sm text-gray-600"},M={class:"w-64"},T=["onUpdate:modelValue"],q=["onUpdate:modelValue"],B=["onUpdate:modelValue"],O={class:"flex gap-2 mt-2"},z=["onClick"],J=["onClick"];function K(s,e,r,m,d,i){return c(),p("div",k,[e[22]||(e[22]=t("h1",{class:"text-2xl font-bold mb-4"},"Admin — Plans",-1)),d.loading?(c(),p("div",w,"Chargement...")):(c(),p("div",E,[t("div",A,[e[11]||(e[11]=t("h3",{class:"font-semibold mb-2"},"Accorder un add-on à un utilisateur",-1)),t("div",S,[n(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.addonForm.user_id=a),placeholder:"user_id",class:"p-2 border rounded col-span-1"},null,512),[[l,s.addonForm.user_id]]),n(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.addonForm.addon_key=a),class:"p-2 border rounded col-span-1"},[...e[10]||(e[10]=[t("option",{value:"dedicated_number"},"dedicated_number",-1),t("option",{value:"extra_concurrency"},"extra_concurrency",-1)])],512),[[b,s.addonForm.addon_key]]),n(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.addonForm.value=a),placeholder:"value (json)",class:"p-2 border rounded col-span-1"},null,512),[[l,s.addonForm.value]])]),t("div",I,[t("button",{onClick:e[3]||(e[3]=(...a)=>i.grantAddon&&i.grantAddon(...a)),class:"bg-blue-600 text-white px-3 py-1 rounded"},"Accorder add-on")])]),t("div",C,[e[12]||(e[12]=t("h3",{class:"font-semibold mb-2"},"Sécurité admin",-1)),e[13]||(e[13]=t("p",{class:"text-sm text-gray-600"},"Changez l'email et le mot de passe administrateur ci-dessous.",-1)),e[14]||(e[14]=t("label",{class:"text-xs"},"Email admin",-1)),n(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>d.adminEmailInput=a),placeholder:"admin@...",class:"w-full p-2 border rounded mb-2"},null,512),[[l,d.adminEmailInput]]),e[15]||(e[15]=t("label",{class:"text-xs"},"Nouveau mot de passe",-1)),n(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>d.adminPasswordInput=a),type:"password",placeholder:"mot de passe",class:"w-full p-2 border rounded mb-2"},null,512),[[l,d.adminPasswordInput]]),t("div",F,[t("button",{onClick:e[6]||(e[6]=(...a)=>i.saveAdminCredentials&&i.saveAdminCredentials(...a)),class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer identifiants"),t("button",{onClick:e[7]||(e[7]=(...a)=>i.clearAdminToken&&i.clearAdminToken(...a)),class:"px-3 py-1 border rounded"},"Déconnecter session admin")])]),t("div",V,[e[16]||(e[16]=t("h3",{class:"font-semibold mb-2"},"Configuration",-1)),e[17]||(e[17]=t("label",{class:"text-xs"},"Email support",-1)),t("div",U,[n(t("input",{"onUpdate:modelValue":e[8]||(e[8]=a=>d.supportEmail=a),placeholder:"support@...",class:"p-2 border rounded flex-1"},null,512),[[l,d.supportEmail]]),t("button",{onClick:e[9]||(e[9]=(...a)=>i.saveSupportEmail&&i.saveSupportEmail(...a)),disabled:d.supportLoading,class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer",8,P)]),e[18]||(e[18]=t("p",{class:"text-xs text-gray-500 mt-2"},[y("L'adresse ci-dessus est utilisée par la page "),t("strong",null,"Pricing"),y(" pour l'envoi d'emails de support.")],-1))]),(c(!0),p(h,null,f(d.plans,a=>(c(),p("div",{key:a.slug,class:"mb-4 bg-white p-4 rounded shadow"},[t("div",j,[t("div",null,[t("div",L,[y(g(a.name)+" ",1),t("span",N,"("+g(a.slug)+")",1)]),t("div",D,g(a.description),1)]),t("div",M,[e[19]||(e[19]=t("label",{class:"text-xs"},"Prix / mois (USD)",-1)),n(t("input",{type:"number","onUpdate:modelValue":u=>d.editable[a.slug].monthly_price=u,class:"w-full p-2 border rounded"},null,8,T),[[l,d.editable[a.slug].monthly_price,void 0,{number:!0}]]),e[20]||(e[20]=t("label",{class:"text-xs"},"Minutes incluses",-1)),n(t("input",{type:"number","onUpdate:modelValue":u=>d.editable[a.slug].included_minutes=u,class:"w-full p-2 border rounded"},null,8,q),[[l,d.editable[a.slug].included_minutes,void 0,{number:!0}]]),e[21]||(e[21]=t("label",{class:"text-xs"},"Overage (cents/min)",-1)),n(t("input",{type:"number","onUpdate:modelValue":u=>d.editable[a.slug].per_min_cents=u,class:"w-full p-2 border rounded"},null,8,B),[[l,d.editable[a.slug].per_min_cents,void 0,{number:!0}]]),t("div",O,[t("button",{onClick:u=>i.save(a.slug),class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer",8,z),t("button",{onClick:u=>i.reset(a.slug),class:"bg-gray-200 px-3 py-1 rounded"},"Annuler",8,J)])])])]))),128))]))])}const R=_(x,[["render",K]]);export{R as default};
