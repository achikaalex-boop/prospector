import{c as i,e as t,b as m,t as c,F as h,n as _,x as y,aL as g,q as u,o,E as f}from"./index-Dh6sIx4Y.js";import{_ as b}from"./_plugin-vue_export-helper-DlAUqK2U.js";const p={name:"Account",data(){return{plan:null,balanceCents:0,balanceLoading:!0,transactions:[],loadingTransactions:!0,dedicatedNumbers:[],pendingRequests:[],requestCountry:"",requestLoading:!1,requestMessage:""}},computed:{planLabel(){return this.plan?this.plan.plan_slug||this.plan.slug||"Starter":"Starter (par défaut)"},planExpired(){try{return!this.plan||!this.plan.expires_at?!1:new Date(this.plan.expires_at)<=new Date}catch{return!1}}},async created(){await Promise.all([this.fetchPlan(),this.fetchBalance(),this.fetchTransactions(),this.fetchDedicatedNumbers(),this.fetchPendingRequests()])},methods:{formatDate(s){try{return new Date(s).toLocaleString()}catch{return s}},displayMoney(s){return((Number(s)||0)/100).toFixed(2)},async fetchPlan(){try{const{data:{session:s}}=await u.auth.getSession(),e=s?.user?.id||null;if(!e)return;const{data:d,error:l}=await u.from("user_plans").select("*").eq("user_id",e).order("started_at",{ascending:!1}).limit(1).single();!l&&d&&(this.plan=d)}catch(s){console.error("fetchPlan error",s)}},async fetchBalance(){this.balanceLoading=!0;try{const{data:{session:s}}=await u.auth.getSession(),e=s?.user?.id||null;if(!e){this.balanceCents=0,this.balanceLoading=!1;return}const{data:d,error:l}=await u.from("user_credits").select("amount").eq("user_id",e);if(!l&&Array.isArray(d)){const n=d.reduce((r,a)=>r+(Number(a.amount)||0),0);this.balanceCents=Math.round(n*100)}else this.balanceCents=0}catch(s){console.error("fetchBalance error",s),this.balanceCents=0}finally{this.balanceLoading=!1}},async fetchTransactions(){this.loadingTransactions=!0;try{const{data:{session:s}}=await u.auth.getSession(),e=s?.user?.id||null;if(!e)return;const{data:d}=await u.from("user_credits").select("id,amount,currency,source,meta,created_at").eq("user_id",e).order("created_at",{ascending:!1}).limit(50),{data:l}=await u.from("billing_transactions").select("id,amount_cents,currency,status,meta,created_at").eq("user_id",e).order("created_at",{ascending:!1}).limit(20),n=[];Array.isArray(d)&&d.forEach(r=>n.push({id:r.id,amount:Number(r.amount),currency:r.currency,source:r.source,description:r.source,created_at:r.created_at})),Array.isArray(l)&&l.forEach(r=>n.push({id:r.id,amount:r.amount_cents?Number(r.amount_cents)/100:0,currency:r.currency,source:"billing",description:r.status||"billing",created_at:r.created_at})),n.sort((r,a)=>new Date(a.created_at)-new Date(r.created_at)),this.transactions=n.slice(0,50)}catch(s){console.error("fetchTransactions error",s)}finally{this.loadingTransactions=!1}},async fetchDedicatedNumbers(){try{const{data:{session:s}}=await u.auth.getSession(),e=s?.user?.id||null;if(!e)return;const{data:d,error:l}=await u.from("user_dedicated_numbers").select("id,number,country_code,created_at").eq("user_id",e);!l&&Array.isArray(d)&&(this.dedicatedNumbers=d)}catch(s){console.error("fetchDedicatedNumbers error",s)}},async fetchPendingRequests(){try{const{data:{session:s}}=await u.auth.getSession(),e=s?.user?.id||null;if(!e)return;const{data:d,error:l}=await u.from("dedicated_number_requests").select("id,country_code,status,created_at").eq("user_id",e).order("created_at",{ascending:!1});!l&&Array.isArray(d)&&(this.pendingRequests=d)}catch(s){console.error("fetchPendingRequests error",s)}},async submitDedicatedRequest(){try{if(!this.requestCountry||String(this.requestCountry).trim()===""){this.requestMessage="Veuillez indiquer un code pays (ex: FR)";return}this.requestLoading=!0,this.requestMessage="";const s=(await u.auth.getSession())?.data?.session?.access_token;if(!s){this.requestMessage="Vous devez être connecté pour faire une demande.",this.requestLoading=!1;return}const e=await fetch("/api/dedicated-number-requests",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({country_code:String(this.requestCountry).trim()})}),d=await e.json();e.ok&&d.ok?(this.requestMessage="Demande envoyée — elle sera traitée par un administrateur.",this.requestCountry="",await this.fetchPendingRequests()):this.requestMessage=d?.error||"Erreur lors de la création de la demande."}catch(s){console.error("submitDedicatedRequest error",s),this.requestMessage=s?.message||String(s)}finally{this.requestLoading=!1}},goToPricing(){this.$router.push("/pricing")}}},x={class:"p-6 max-w-3xl mx-auto"},v={class:"bg-white p-4 rounded shadow mb-4"},q={class:"flex items-center justify-between"},w={class:"text-lg font-semibold"},D={key:0,class:"text-sm text-gray-500"},k={key:1,class:"text-sm text-gray-500"},C={key:2,class:"text-sm text-red-600"},S={class:"text-right"},P={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},A={class:"bg-white p-4 rounded shadow"},M={key:0},L={key:1,class:"text-lg font-bold"},N={class:"bg-white p-4 rounded shadow"},R={key:0},T={key:1},E={class:"text-sm"},j={class:"flex justify-between"},B={class:"font-medium"},F={class:"text-gray-500 text-xs"},I={class:"text-right"},V={class:"text-xs text-gray-500"},z={key:0,class:"text-sm text-gray-500"},U={class:"mt-4 bg-white p-4 rounded shadow max-w-3xl mx-auto"},O={key:0,class:"text-sm text-gray-500"},H={key:1,class:"text-sm"},J={class:"flex justify-between items-center"},G={class:"font-medium"},K={class:"text-xs text-gray-500"},Q={class:"flex gap-2 mt-2"},W=["disabled"],X={key:2,class:"text-sm text-green-600 mt-2"},Y={key:3,class:"mt-4"},Z={class:"text-sm mt-2"},$={class:"flex justify-between"},ee={class:"font-medium"},te={class:"text-xs text-gray-500"};function se(s,e,d,l,n,r){return o(),i("div",x,[e[11]||(e[11]=t("h1",{class:"text-2xl font-bold mb-4"},"Mon compte — Abonnement",-1)),t("div",v,[t("div",q,[t("div",null,[e[3]||(e[3]=t("div",{class:"text-sm text-gray-600"},"Plan actuel",-1)),t("div",w,c(r.planLabel),1),n.plan&&n.plan.started_at?(o(),i("div",D,"Commencé: "+c(r.formatDate(n.plan.started_at)),1)):m("",!0),n.plan&&n.plan.expires_at?(o(),i("div",k,"Expire: "+c(r.formatDate(n.plan.expires_at)),1)):m("",!0),r.planExpired?(o(),i("div",C,"Expiré — vous êtes sur Starter")):m("",!0)]),t("div",S,[t("button",{onClick:e[0]||(e[0]=(...a)=>r.goToPricing&&r.goToPricing(...a)),class:"bg-blue-600 text-white px-4 py-2 rounded"},"Changer le plan")])])]),t("div",P,[t("div",A,[e[4]||(e[4]=t("h3",{class:"font-semibold mb-2"},"Solde",-1)),n.balanceLoading?(o(),i("div",M,"Chargement...")):(o(),i("div",L,c(r.displayMoney(n.balanceCents))+" USD",1))]),t("div",N,[e[5]||(e[5]=t("h3",{class:"font-semibold mb-2"},"Historique des paiements",-1)),n.loadingTransactions?(o(),i("div",R,"Chargement...")):(o(),i("div",T,[t("ul",E,[(o(!0),i(h,null,_(n.transactions,a=>(o(),i("li",{key:a.id,class:"py-2 border-b"},[t("div",j,[t("div",null,[t("div",B,c(a.description||a.source||"Transaction"),1),t("div",F,c(r.formatDate(a.created_at)),1)]),t("div",I,[t("div",{class:f(a.amount<0?"text-red-600":"text-green-600")},c(a.amount<0?"-":"+")+c(r.displayMoney(Math.abs(a.amount*100)))+" USD",3),t("div",V,c(a.currency||"USD"),1)])])]))),128))]),n.transactions.length===0?(o(),i("div",z,"Aucune transaction récente.")):m("",!0)]))])]),t("div",U,[e[9]||(e[9]=t("h3",{class:"font-semibold mb-2"},"Numéros dédiés",-1)),n.dedicatedNumbers.length===0?(o(),i("div",O,"Pas de numéro dédié attribué.")):(o(),i("ul",H,[(o(!0),i(h,null,_(n.dedicatedNumbers,a=>(o(),i("li",{key:a.id,class:"py-2 border-b"},[t("div",J,[t("div",null,[t("div",G,c(a.number),1),t("div",K,"Pays: "+c(a.country_code||"—")+" • Ajouté: "+c(r.formatDate(a.created_at)),1)]),e[6]||(e[6]=t("div",{class:"text-sm text-gray-700"}," ",-1))])]))),128))])),e[10]||(e[10]=t("h4",{class:"mt-4 font-semibold"},"Demander un numéro dédié",-1)),t("div",Q,[y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>n.requestCountry=a),placeholder:"Pays (ex: FR)",class:"p-2 border rounded"},null,512),[[g,n.requestCountry]]),t("button",{onClick:e[2]||(e[2]=(...a)=>r.submitDedicatedRequest&&r.submitDedicatedRequest(...a)),disabled:n.requestLoading,class:"bg-blue-600 text-white px-3 py-1 rounded"},"Demander",8,W)]),n.requestMessage?(o(),i("div",X,c(n.requestMessage),1)):m("",!0),n.pendingRequests.length?(o(),i("div",Y,[e[8]||(e[8]=t("h5",{class:"font-semibold text-sm"},"Demandes en attente",-1)),t("ul",Z,[(o(!0),i(h,null,_(n.pendingRequests,a=>(o(),i("li",{key:a.id,class:"py-2 border-b"},[t("div",$,[t("div",null,[t("div",ee,"Pays: "+c(a.country_code),1),t("div",te,"Envoyée: "+c(r.formatDate(a.created_at))+" — Statut: "+c(a.status),1)]),e[7]||(e[7]=t("div",{class:"text-sm text-gray-700"}," ",-1))])]))),128))])])):m("",!0)])])}const ne=b(p,[["render",se]]);export{ne as default};
