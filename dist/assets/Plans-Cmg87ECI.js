import{a as l}from"./index-B9ygI19o.js";import{c as o,e as s,a as w,b as h,w as f,l as p,t as m,M as E,D as b,j as S,F as _,n as v,x as g,aL as y,q as C,o as n}from"./index-CqsXNJoY.js";import{s as q}from"./index-auy-R82D.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";const I={name:"AdminPlans",components:{Message:q},data(){return{plans:[],loading:!0,editable:{},supportEmail:"",supportLoading:!1,adminEmailInput:"",adminPasswordInput:"",pageError:null,adminStatus:null,dedicatedRequests:[],requestsLoading:!1}},async created(){try{const t=localStorage.getItem("admin_token"),e=t?{"x-admin-token":t}:{},i=await l.get("/api/admin/check",{headers:e});if(!i.data||!i.data.ok){this.pageError="Accès refusé: accès administrateur requis. Connectez-vous via /admin.";return}t&&(l.defaults.headers.common["x-admin-token"]=t)}catch(t){console.error("admin check failed",t),this.pageError="Erreur lors de la vérification d'accès administrateur.";return}await this.load(),await this.loadDedicatedRequests(),await this.fetchSupportEmail();try{const t=await l.get("/api/admin/status");this.adminStatus=t.data||null}catch{}},methods:{async load(){this.loading=!0,this.pageError=null;try{const{data:t,error:e}=await C.from("plans").select("*").order("monthly_price_cents",{ascending:!0});e?(console.error("fetch plans error",e),this.pageError="Erreur lors du chargement des plans: "+(e.message||JSON.stringify(e))):Array.isArray(t)&&(this.plans=t,t.forEach(i=>{this.editable[i.slug]={monthly_price:(i.monthly_price_cents||0)/100,included_minutes:i.included_minutes||0,per_min_cents:i.per_min_cents||0}}))}catch(t){console.error(t),this.pageError="Erreur inattendue: "+(t?.message||String(t))}finally{this.loading=!1}},reset(t){if(this.plans){const e=this.plans.find(i=>i.slug===t);e&&(this.editable[t]={monthly_price:(e.monthly_price_cents||0)/100,included_minutes:e.included_minutes||0,per_min_cents:e.per_min_cents||0})}},async save(t){try{const e=this.editable[t],i={slug:t,monthly_price_cents:Math.round(Number(e.monthly_price||0)*100),included_minutes:Number(e.included_minutes||0),per_min_cents:Number(e.per_min_cents||0)},c=await l.post("/api/admin/plan-upsert",i);c.data&&c.data.ok?(this.$toast.add({severity:"success",summary:"Enregistré",detail:"Plan mis à jour",life:4e3}),await this.load()):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour le plan",life:6e3})}catch(e){console.error(e),this.$toast.add({severity:"error",summary:"Erreur",detail:e?.response?.data?.error||e.message||String(e),life:8e3})}},async fetchSupportEmail(){this.supportLoading=!0;try{const t=await l.get("/api/app-settings/support-email");this.supportEmail=t.data?.support_email||""}catch(t){console.error("fetchSupportEmail failed",t),this.supportEmail=""}finally{this.supportLoading=!1}},async saveAdminCredentials(){try{const t=localStorage.getItem("admin_token"),e=t?{"x-admin-token":t}:{},i=await l.post("/api/admin/set-admin-credentials",{email:this.adminEmailInput,password:this.adminPasswordInput},{headers:e});i.data&&i.data.ok?this.$toast.add({severity:"success",summary:"Enregistré",detail:"Identifiants admin mis à jour",life:4e3}):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour",life:6e3})}catch(t){console.error("saveAdminCredentials failed",t),this.$toast.add({severity:"error",summary:"Erreur",detail:t?.response?.data?.error||t.message||String(t),life:8e3})}},clearAdminToken(){localStorage.removeItem("admin_token"),delete l.defaults.headers.common["x-admin-token"],this.$toast.add({severity:"info",summary:"Déconnecté",detail:"Session admin déconnectée localement",life:3e3})},retryAdminCheck(){this.pageError=null,this.$router.replace({path:this.$route.path,query:Object.assign({},this.$route.query,{t:Date.now()})})},formatDate(t){try{return new Date(t).toLocaleString()}catch{return t}},async loadDedicatedRequests(){this.requestsLoading=!0;try{const t=localStorage.getItem("admin_token"),e=t?{"x-admin-token":t}:{},i=await l.get("/api/admin/dedicated-number-requests",{headers:e});this.dedicatedRequests=i.data&&i.data.requests?i.data.requests:[]}catch(t){console.error("loadDedicatedRequests failed",t),this.dedicatedRequests=[]}finally{this.requestsLoading=!1}},async approveRequest(t){try{const e=window.prompt("Numéro à attribuer (E.164), ex: +33123456789");if(!e)return;const i=localStorage.getItem("admin_token"),c=i?{"x-admin-token":i}:{},a=await l.post("/api/admin/approve-dedicated-number",{request_id:t.id,assigned_number:e},{headers:c});a.data&&a.data.ok?(this.$toast.add({severity:"success",summary:"OK",detail:"Numéro attribué",life:4e3}),await this.loadDedicatedRequests()):this.$toast.add({severity:"error",summary:"Erreur",detail:"Échec",life:6e3})}catch(e){console.error(e),this.$toast.add({severity:"error",summary:"Erreur",detail:e?.response?.data?.error||e.message||String(e),life:8e3})}},async rejectRequest(t){try{if(!window.confirm("Confirmer le rejet de la demande ?"))return;const e=localStorage.getItem("admin_token"),i=e?{"x-admin-token":e}:{},c=await l.post("/api/admin/reject-dedicated-number",{request_id:t.id},{headers:i});c.data&&c.data.ok&&(this.$toast.add({severity:"success",summary:"OK",detail:"Demande rejetée",life:4e3}),await this.loadDedicatedRequests())}catch(e){console.error(e),this.$toast.add({severity:"error",summary:"Erreur",detail:e?.response?.data?.error||e.message||String(e),life:8e3})}},async saveSupportEmail(){try{const t=localStorage.getItem("admin_token"),e=t?{"x-admin-token":t}:{},i=await l.post("/api/admin/app-settings",{key:"support_email",value:this.supportEmail},{headers:e});i.data&&i.data.ok?this.$toast.add({severity:"success",summary:"Enregistré",detail:"Email de support mis à jour",life:4e3}):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'enregistrer",life:6e3})}catch(t){console.error("saveSupportEmail failed",t),this.$toast.add({severity:"error",summary:"Erreur",detail:t?.response?.data?.error||t.message||String(t),life:8e3})}}}},D={class:"p-6 max-w-4xl mx-auto"},R={key:0},j={key:1},V={class:"mt-2"},L={key:1,class:"mb-4 text-sm text-gray-600"},N={key:2,class:"mb-4 text-sm text-gray-600"},P={class:"mb-4 bg-white p-4 rounded shadow"},U={key:0},M={key:1},O={key:0,class:"text-sm text-gray-500"},T={key:1,class:"text-sm"},z={class:"font-medium"},B={class:"text-xs text-gray-500"},F={class:"flex gap-2"},K=["onClick"],J=["onClick"],G={class:"mb-4 bg-white p-4 rounded shadow"},H={class:"flex gap-2"},Q={class:"mb-4 bg-white p-4 rounded shadow"},W={class:"flex gap-2 mt-2"},X=["disabled"],Y={key:3,class:"mb-4 bg-white p-4 rounded shadow"},Z={key:4},$={class:"flex justify-between items-start"},ee={class:"text-lg font-semibold"},te={class:"text-sm text-gray-500"},se={class:"text-sm text-gray-600"},re={class:"w-64"},ae=["onUpdate:modelValue"],ie=["onUpdate:modelValue"],ne=["onUpdate:modelValue"],oe={class:"flex gap-2 mt-2"},de=["onClick"],le=["onClick"];function ue(t,e,i,c,a,d){const x=b("Message"),k=b("router-link");return n(),o("div",D,[e[23]||(e[23]=s("h1",{class:"text-2xl font-bold mb-4"},"Admin — Plans",-1)),a.loading?(n(),o("div",R,"Chargement...")):(n(),o("div",j,[a.pageError?(n(),w(x,{key:0,severity:"error",closable:!1,class:"mb-4"},{default:f(()=>[p(m(a.pageError)+" ",1),s("div",V,[s("button",{onClick:e[0]||(e[0]=E((...r)=>d.retryAdminCheck&&d.retryAdminCheck(...r),["prevent"])),class:"px-3 py-1 border rounded"},"Re-tester l'accès admin")])]),_:1})):h("",!0),a.adminStatus&&a.adminStatus.initialized===!1?(n(),o("div",L,[e[8]||(e[8]=p("Administration non initialisée. Vous pouvez ",-1)),S(k,{to:"/admin"},{default:f(()=>[...e[7]||(e[7]=[p("initialiser",-1)])]),_:1}),e[9]||(e[9]=p(" un compte admin.",-1))])):h("",!0),a.adminStatus&&a.adminStatus.admin_email?(n(),o("div",N,[e[10]||(e[10]=p("Compte admin: ",-1)),s("strong",null,m(a.adminStatus.admin_email),1)])):h("",!0),s("div",P,[e[11]||(e[11]=s("h3",{class:"font-semibold mb-2"},"Demandes de numéro dédié",-1)),a.requestsLoading?(n(),o("div",U,"Chargement...")):(n(),o("div",M,[a.dedicatedRequests.length===0?(n(),o("div",O,"Aucune demande en attente.")):(n(),o("ul",T,[(n(!0),o(_,null,v(a.dedicatedRequests,r=>(n(),o("li",{key:r.id,class:"py-2 border-b flex justify-between items-center"},[s("div",null,[s("div",z,m(r.user_id)+" — "+m(r.country_code),1),s("div",B,"Envoyée: "+m(d.formatDate(r.created_at))+" — Statut: "+m(r.status),1)]),s("div",F,[s("button",{onClick:u=>d.approveRequest(r),class:"bg-green-600 text-white px-3 py-1 rounded"},"Approuver",8,K),s("button",{onClick:u=>d.rejectRequest(r),class:"px-3 py-1 border rounded"},"Rejeter",8,J)])]))),128))]))]))]),s("div",G,[e[12]||(e[12]=s("h3",{class:"font-semibold mb-2"},"Sécurité admin",-1)),e[13]||(e[13]=s("p",{class:"text-sm text-gray-600"},"Changez l'email et le mot de passe administrateur ci-dessous.",-1)),e[14]||(e[14]=s("label",{class:"text-xs"},"Email admin",-1)),g(s("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>a.adminEmailInput=r),placeholder:"admin@...",class:"w-full p-2 border rounded mb-2"},null,512),[[y,a.adminEmailInput]]),e[15]||(e[15]=s("label",{class:"text-xs"},"Nouveau mot de passe",-1)),g(s("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>a.adminPasswordInput=r),type:"password",placeholder:"mot de passe",class:"w-full p-2 border rounded mb-2"},null,512),[[y,a.adminPasswordInput]]),s("div",H,[s("button",{onClick:e[3]||(e[3]=(...r)=>d.saveAdminCredentials&&d.saveAdminCredentials(...r)),class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer identifiants"),s("button",{onClick:e[4]||(e[4]=(...r)=>d.clearAdminToken&&d.clearAdminToken(...r)),class:"px-3 py-1 border rounded"},"Déconnecter session admin")])]),s("div",Q,[e[16]||(e[16]=s("h3",{class:"font-semibold mb-2"},"Configuration",-1)),e[17]||(e[17]=s("label",{class:"text-xs"},"Email support",-1)),s("div",W,[g(s("input",{"onUpdate:modelValue":e[5]||(e[5]=r=>a.supportEmail=r),placeholder:"support@...",class:"p-2 border rounded flex-1"},null,512),[[y,a.supportEmail]]),s("button",{onClick:e[6]||(e[6]=(...r)=>d.saveSupportEmail&&d.saveSupportEmail(...r)),disabled:a.supportLoading,class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer",8,X)]),e[18]||(e[18]=s("p",{class:"text-xs text-gray-500 mt-2"},[p("L'adresse ci-dessus est utilisée par la page "),s("strong",null,"Pricing"),p(" pour l'envoi d'emails de support.")],-1))]),!a.plans||a.plans.length===0?(n(),o("div",Y,[...e[19]||(e[19]=[s("div",{class:"text-sm text-gray-600"},"Aucun plan trouvé.",-1)])])):(n(),o("div",Z,[(n(!0),o(_,null,v(a.plans,r=>(n(),o("div",{key:r.slug,class:"mb-4 bg-white p-4 rounded shadow"},[s("div",$,[s("div",null,[s("div",ee,[p(m(r.name)+" ",1),s("span",te,"("+m(r.slug)+")",1)]),s("div",se,m(r.description),1)]),s("div",re,[e[20]||(e[20]=s("label",{class:"text-xs"},"Prix / mois (USD)",-1)),g(s("input",{type:"number","onUpdate:modelValue":u=>a.editable[r.slug].monthly_price=u,class:"w-full p-2 border rounded"},null,8,ae),[[y,a.editable[r.slug].monthly_price,void 0,{number:!0}]]),e[21]||(e[21]=s("label",{class:"text-xs"},"Minutes incluses",-1)),g(s("input",{type:"number","onUpdate:modelValue":u=>a.editable[r.slug].included_minutes=u,class:"w-full p-2 border rounded"},null,8,ie),[[y,a.editable[r.slug].included_minutes,void 0,{number:!0}]]),e[22]||(e[22]=s("label",{class:"text-xs"},"Overage (cents/min)",-1)),g(s("input",{type:"number","onUpdate:modelValue":u=>a.editable[r.slug].per_min_cents=u,class:"w-full p-2 border rounded"},null,8,ne),[[y,a.editable[r.slug].per_min_cents,void 0,{number:!0}]]),s("div",oe,[s("button",{onClick:u=>d.save(r.slug),class:"bg-green-600 text-white px-3 py-1 rounded"},"Enregistrer",8,de),s("button",{onClick:u=>d.reset(r.slug),class:"bg-gray-200 px-3 py-1 rounded"},"Annuler",8,le)])])])]))),128))]))]))])}const ye=A(I,[["render",ue]]);export{ye as default};
