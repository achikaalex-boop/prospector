import{a as g}from"./index-B9ygI19o.js";import{c as o,e as t,b as c,F as _,I as y,t as u,J as h,o as a,A as b,D as m}from"./index-Cm5piLp0.js";import{_ as f}from"./_plugin-vue_export-helper-DlAUqK2U.js";const x={name:"Pricing",data(){return{uiPlans:[{slug:"free",name:"Starter",monthly_price:0,per_min_cents:17,concurrency:5,included_minutes:20},{slug:"standard",name:"Standard",monthly_price:19,per_min_cents:15,concurrency:10,included_minutes:200},{slug:"pro",name:"Pro",monthly_price:49,per_min_cents:12,concurrency:20,included_minutes:1e3}],balanceCents:0,balanceLoading:!0,approvalLink:null,showRedirectModal:!1,isLoading:!1,estimatorMinutes:{},defaultEstimateMinutes:10}},async created(){await Promise.all([this.fetchPlans(),this.fetchBalance()])},mounted(){window.addEventListener("balance:updated",this.fetchBalance)},unmounted(){window.removeEventListener("balance:updated",this.fetchBalance)},methods:{async fetchPlans(){try{const{data:n,error:e}=await h.from("plans").select("slug,name,monthly_price,per_min_cents,concurrency,included_minutes");!e&&Array.isArray(n)&&n.length?(this.uiPlans=n.map(i=>({slug:i.slug,name:i.name,monthly_price:Number(i.monthly_price)||0,per_min_cents:Number(i.per_min_cents)||0,concurrency:Number(i.concurrency)||0,included_minutes:Number(i.included_minutes)||0})),this.uiPlans.forEach(i=>{this.estimatorMinutes[i.slug]=this.defaultEstimateMinutes})):this.uiPlans.forEach(i=>{this.estimatorMinutes[i.slug]=this.defaultEstimateMinutes})}catch(n){console.error("fetchPlans error",n),this.uiPlans.forEach(e=>{this.estimatorMinutes[e.slug]=this.defaultEstimateMinutes})}},async fetchBalance(){this.balanceLoading=!0;try{let n=null;try{const{data:{session:d}}=await h.auth.getSession();n=d?.user?.id||null}catch{}if(!n){this.balanceCents=0,this.balanceLoading=!1;return}const{data:e,error:i}=await h.from("user_credits").select("amount").eq("user_id",n);if(!i&&Array.isArray(e)){const d=e.reduce((r,l)=>r+(Number(l.amount)||0),0);this.balanceCents=Math.round(d*100)}else this.balanceCents=0}catch(n){console.error("Could not fetch balance",n),this.balanceCents=0}finally{this.balanceLoading=!1}},async subscribe(n){try{this.isLoading=!0;let e=null;try{const{data:{session:s}}=await h.auth.getSession();e=s?.user?.id||null}catch{}const i=Math.round(n.monthly_price*100),l=((await g.post("/api/subscribe",{plan_slug:n.slug,amount_cents:i,user_id:e})).data?.links||[]).find(s=>s.rel==="approve");this.approvalLink=l?l.href:null,this.approvalLink?this.showRedirectModal=!0:alert("Impossible d'obtenir le lien PayPal d'approbation")}catch(e){console.error("subscribe error",e),alert("Erreur lors de la création de la souscription: "+(e?.response?.data?.error||e.message||e))}finally{this.isLoading=!1}},openApprovalFromModal(){this.approvalLink&&(window.open(this.approvalLink,"_blank"),this.showRedirectModal=!1)},cancelRedirect(){this.showRedirectModal=!1},estimateCostCents(n,e){const i=Number(e)||0;return Math.round((Number(n.per_min_cents)||0)*i)},displayMoney(n){return((Number(n)||0)/100).toFixed(2)},needsTopupCents(n,e){const i=Number(e)||0,d=Number(n.included_minutes)||0,r=Math.max(0,i-d),l=this.estimateCostCents(n,r);return Math.max(0,l-this.balanceCents)}}},v={class:"p-6 max-w-3xl mx-auto"},M={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},C={class:"flex items-center justify-between"},w={class:"text-lg font-semibold"},k={key:0,class:"text-xs uppercase px-2 py-1 bg-white/20 rounded"},P={class:"mt-4"},L={class:"text-3xl font-bold"},E={class:"mt-4 text-sm"},N={key:0},S={class:"mt-4 bg-gray-50 p-3 rounded"},A={class:"mt-2 flex items-center gap-2"},F=["value","onInput"],R={class:"text-sm"},B={class:"mt-2 text-sm text-gray-700"},D={key:0},z={key:1},T={key:0,class:"ml-2 text-red-600"},U={class:"mt-6"},I=["onClick"],V={class:"mt-6"},j={key:0},q={key:1,class:"text-lg"},J={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"},O={class:"bg-white rounded-lg p-6 w-full max-w-md"},G={class:"flex items-center gap-3"},H={key:0,class:"ml-auto text-sm text-gray-600"};function K(n,e,i,d,r,l){return a(),o("div",v,[e[12]||(e[12]=t("h1",{class:"text-3xl font-bold mb-4"},"Abonnements",-1)),e[13]||(e[13]=t("div",{class:"mb-4 text-sm text-gray-600"},"Choisissez un abonnement. Les appels sont facturés à la minute en plus si applicable.",-1)),t("div",M,[(a(!0),o(_,null,y(r.uiPlans,s=>(a(),o("div",{key:s.slug,class:b(["p-6 rounded-lg",s.slug==="pro"?"bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg":"bg-white border"])},[t("div",C,[t("h3",w,u(s.name),1),s.slug==="pro"?(a(),o("span",k,"Populaire")):c("",!0)]),t("div",P,[t("div",L,"$"+u(s.monthly_price.toFixed(2)),1),e[2]||(e[2]=t("div",{class:"text-sm text-gray-200/80"},"/ mois",-1))]),t("ul",E,[t("li",null,[e[3]||(e[3]=m("Concurrency: ",-1)),t("strong",null,u(s.concurrency),1)]),t("li",null,[e[4]||(e[4]=m("Per-minute estimé: ",-1)),t("strong",null,u(s.per_min_cents)+"¢",1)]),s.included_minutes?(a(),o("li",N,[e[5]||(e[5]=m("Minutes inclues: ",-1)),t("strong",null,u(s.included_minutes),1)])):c("",!0)]),t("div",S,[e[8]||(e[8]=t("label",{class:"text-sm"},"Estimation d'appel (minutes)",-1)),t("div",A,[t("input",{type:"number",min:"0",value:r.estimatorMinutes[s.slug],onInput:p=>{this.estimatorMinutes[s.slug]=Number(p.target.value)},class:"w-24 p-2 border rounded"},null,40,F),t("div",R,[e[6]||(e[6]=m("Coût estimé: ",-1)),t("strong",null,u(l.displayMoney(l.estimateCostCents(s,r.estimatorMinutes[s.slug]||r.defaultEstimateMinutes)))+" USD",1)])]),t("div",B,[r.balanceLoading?(a(),o("div",D,"Chargement du solde...")):(a(),o("div",z,[e[7]||(e[7]=m(" Solde: ",-1)),t("strong",null,u(l.displayMoney(r.balanceCents))+" USD",1),l.needsTopupCents(s,r.estimatorMinutes[s.slug]||r.defaultEstimateMinutes)>0?(a(),o("span",T,"(Top-up requis: "+u(l.displayMoney(l.needsTopupCents(s,r.estimatorMinutes[s.slug]||r.defaultEstimateMinutes)))+" USD)",1)):c("",!0)]))])]),t("div",U,[t("button",{onClick:p=>l.subscribe(s),class:b(s.slug==="pro"?"bg-white text-blue-700 px-4 py-2 rounded":"bg-blue-600 text-white px-4 py-2 rounded")},"S'abonner",10,I)])],2))),128))]),t("div",V,[e[9]||(e[9]=t("h2",{class:"text-xl font-semibold mb-2"},"Solde",-1)),r.balanceLoading?(a(),o("div",j,"Chargement du solde...")):(a(),o("div",q,u((r.balanceCents/100).toFixed(2))+" USD",1))]),r.showRedirectModal?(a(),o("div",J,[t("div",O,[e[10]||(e[10]=t("h3",{class:"text-lg font-semibold mb-2"},"Confirmer la souscription",-1)),e[11]||(e[11]=t("p",{class:"text-sm text-gray-700 mb-4"},"Vous allez être redirigé vers PayPal pour autoriser le paiement. Une fois approuvé, vous serez redirigé vers la page de confirmation.",-1)),t("div",G,[t("button",{onClick:e[0]||(e[0]=(...s)=>l.openApprovalFromModal&&l.openApprovalFromModal(...s)),class:"bg-blue-600 text-white px-4 py-2 rounded"},"Ouvrir PayPal"),t("button",{onClick:e[1]||(e[1]=(...s)=>l.cancelRedirect&&l.cancelRedirect(...s)),class:"px-4 py-2 border rounded"},"Annuler"),r.isLoading?(a(),o("div",H,"Chargement...")):c("",!0)])])])):c("",!0)])}const Y=f(x,[["render",K]]);export{Y as default};
