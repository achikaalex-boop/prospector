import{a as p}from"./index-B9ygI19o.js";import{c as a,e as n,F as f,n as g,q as _,o as l,E as h,b as m,l as d,t as c}from"./index-Dh6sIx4Y.js";import{_ as x}from"./_plugin-vue_export-helper-DlAUqK2U.js";const v={name:"Pricing",data(){return{uiPlans:[{slug:"free",name:"Starter",monthly_price:0,per_min_cents:30,concurrency:5,included_minutes:20},{slug:"standard",name:"Standard",monthly_price:19,per_min_cents:30,concurrency:10,included_minutes:200},{slug:"pro",name:"Pro",monthly_price:49,per_min_cents:30,concurrency:20,included_minutes:1e3}],activePlan:null,balanceCents:0,balanceLoading:!0,approvalLink:null,isLoading:!1,estimatorMinutes:{},defaultEstimateMinutes:10}},async created(){await Promise.all([this.fetchPlans(),this.fetchBalance(),this.fetchActivePlan()])},mounted(){window.addEventListener("balance:updated",this.fetchBalance),window.addEventListener("plan:updated",this.fetchActivePlan)},unmounted(){window.removeEventListener("balance:updated",this.fetchBalance),window.removeEventListener("plan:updated",this.fetchActivePlan)},methods:{monthlyPriceCents(t){return t==null?0:typeof t.monthly_price=="number"?Math.round(t.monthly_price*100):typeof t.monthly_price_cents=="number"?Math.round(t.monthly_price_cents):0},formatDescription(t){return t?String(t).split(/[.;\n]+/).map(e=>e.trim()).filter(Boolean):[]},async fetchPlans(){try{const{data:t,error:e}=await _.from("plans").select("slug,name,monthly_price_cents,per_min_cents,max_concurrency,included_minutes,description,tagline,objective,minutes_expiry_days,card_required,network_priority,soft_limit_percent,has_dedicated_number,has_extra_concurrency");!e&&Array.isArray(t)&&t.length?(this.uiPlans=t.map(s=>({slug:s.slug,name:s.name,monthly_price:(Number(s.monthly_price_cents)||0)/100,monthly_price_cents:Number(s.monthly_price_cents)||0,per_min_cents:Number(s.per_min_cents)||0,concurrency:Number(s.max_concurrency)||Number(s.concurrency)||0,max_concurrency:Number(s.max_concurrency)||0,included_minutes:Number(s.included_minutes)||0,description:s.description||"",tagline:s.tagline||"",objective:s.objective||"",minutes_expiry_days:s.minutes_expiry_days||null,card_required:s.card_required===!0,network_priority:s.network_priority||"standard",soft_limit_percent:s.soft_limit_percent||null,has_dedicated_number:s.has_dedicated_number===!0,has_extra_concurrency:s.has_extra_concurrency===!0})),this.uiPlans.forEach(s=>{this.estimatorMinutes[s.slug]=this.defaultEstimateMinutes})):this.uiPlans.forEach(s=>{this.estimatorMinutes[s.slug]=this.defaultEstimateMinutes})}catch(t){console.error("fetchPlans error",t),this.uiPlans.forEach(e=>{this.estimatorMinutes[e.slug]=this.defaultEstimateMinutes})}},async fetchBalance(){this.balanceLoading=!0;try{let t=null;try{const{data:{session:u}}=await _.auth.getSession();t=u?.user?.id||null}catch{}if(!t){this.balanceCents=0,this.balanceLoading=!1;return}const{data:e,error:s}=await _.from("user_credits").select("amount").eq("user_id",t);if(!s&&Array.isArray(e)){const u=e.reduce((o,r)=>o+(Number(r.amount)||0),0);this.balanceCents=Math.round(u*100)}else this.balanceCents=0}catch(t){console.error("Could not fetch balance",t),this.balanceCents=0}finally{this.balanceLoading=!1}},async fetchActivePlan(){try{let t=null;try{const{data:{session:u}}=await _.auth.getSession();t=u?.user?.id||null}catch{}if(!t)return;const e=await fetch(`/api/user-plan?user_id=${t}`);if(!e.ok)return;const s=await e.json();this.activePlan=s.plan||null}catch{}},async subscribe(t){try{this.isLoading=!0;let e=null;try{const{data:{session:s}}=await _.auth.getSession();e=s?.user?.id||null}catch{}if(this.isPlanActive(t)){this.$toast.add({severity:"info",summary:"Abonnement",detail:"Vous √™tes d√©j√† abonn√© √† ce plan.",life:4e3});return}this.activePlan&&this.isDowngrade(t)?this.$confirm({message:"Vous changez vers un plan moins avantageux. Cette action peut √™tre irr√©versible. Voulez-vous continuer ?",header:"Confirmer la modification",icon:"pi pi-exclamation-triangle",accept:async()=>{await this.performSubscribe(t,e)},reject:()=>{}}):await this.performSubscribe(t,e)}catch(e){console.error("subscribe error",e),this.$toast.add({severity:"error",summary:"Erreur",detail:"Erreur lors de la cr√©ation de la souscription: "+(e?.response?.data?.error||e.message||e),life:8e3})}finally{this.isLoading=!1}},async performSubscribe(t,e){try{const s=Math.round(t.monthly_price*100),r=((await p.post("/api/subscribe",{plan_slug:t.slug,amount_cents:s,user_id:e})).data?.links||[]).find(i=>i.rel==="approve");this.approvalLink=r?r.href:null,this.approvalLink?(s>(this.balanceCents||0)&&this.$toast.add({severity:"warn",summary:"Solde insuffisant",detail:"Votre solde est insuffisant pour ce plan. Vous serez redirig√© vers PayPal pour compl√©ter le paiement.",life:6e3}),window.location.href=this.approvalLink):this.$toast.add({severity:"error",summary:"Erreur",detail:"Impossible d'obtenir le lien PayPal d'approbation",life:6e3})}catch(s){throw s}},isPlanActive(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;return e&&e===t.slug}catch{return!1}},isDowngrade(t){try{if(!this.activePlan)return!1;const e=this.activePlan.plan_slug||this.activePlan.slug||null;if(!e)return!1;const s=this.uiPlans.find(o=>o.slug===e),u=this.uiPlans.find(o=>o.slug===t.slug);return!s||!u?!1:Number(u.monthly_price||0)<Number(s.monthly_price||0)}catch{return!1}},estimateCostCents(t,e){const s=Number(e)||0;return Math.round((Number(t.per_min_cents)||0)*s)},displayMoney(t){return((Number(t)||0)/100).toFixed(2)},needsTopupCents(t,e){const s=Number(e)||0,u=Number(t.included_minutes)||0,o=Math.max(0,s-u),r=this.estimateCostCents(t,o);return Math.max(0,r-this.balanceCents)}}},P={class:"p-6 max-w-4xl mx-auto"},w={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},k={class:"flex items-start justify-between gap-3"},C={class:"flex items-center gap-2"},M={key:0,class:"text-green-500"},A={key:1,class:"text-blue-500"},L={key:2,class:"text-red-500"},N={class:"text-lg font-semibold"},S={class:"text-xs ml-2 text-gray-500"},E={class:"mt-3 text-sm text-gray-200/80"},j={class:"text-right"},B={key:0,class:"text-xs uppercase px-2 py-1 bg-green-600 text-white rounded"},D={class:"mt-4 text-sm"},V={key:0,class:"mb-2"},q={class:"mt-2 space-y-1"},z={key:0},F={class:"mt-2 space-y-1"},T={class:"mt-2 space-y-1 text-sm text-gray-700"},U={key:0},I={key:1},O={key:2},G={key:1,class:"mt-3 text-xs text-gray-500"},H={class:"list-disc ml-4 space-y-1"},J={class:"mt-4"},K={key:0,class:"flex items-center gap-2"},Q=["onClick","disabled"],R={key:1,class:"px-4 py-2 border rounded text-sm text-gray-600"};function W(t,e,s,u,o,r){return l(),a("div",P,[e[14]||(e[14]=n("h1",{class:"text-3xl font-bold mb-4"},"Abonnements",-1)),e[15]||(e[15]=n("div",{class:"mb-4 text-sm text-gray-600"},"Choisissez un abonnement adapt√© √† votre usage. Les appels sont factur√©s √† la minute en sus si applicable.",-1)),n("div",w,[(l(!0),a(f,null,g(o.uiPlans,i=>(l(),a("div",{key:i.slug,class:h(["p-6 rounded-lg",i.slug==="pro"?"bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg":"bg-white border"])},[n("div",k,[n("div",null,[n("div",C,[i.slug==="free"?(l(),a("span",M,"üü¢")):i.slug==="starter"||i.slug==="standard"?(l(),a("span",A,"üîµ")):i.slug==="pro"?(l(),a("span",L,"üî¥")):m("",!0),n("h3",N,[d(c(i.name)+" ",1),n("span",S,c(i.tagline||""),1)])]),n("div",E,[n("div",{class:h(["text-xl font-bold",i.slug==="pro"?"text-white":"text-gray-900"])},c(r.displayMoney(r.monthlyPriceCents(i)))+" USD",3),e[0]||(e[0]=n("div",{class:"text-sm text-gray-400"},"/ mois",-1))])]),n("div",j,[o.activePlan&&(o.activePlan.plan_slug===i.slug||o.activePlan.slug===i.slug)?(l(),a("div",B,"Actif")):m("",!0)])]),n("div",D,[i.objective?(l(),a("p",V,[e[1]||(e[1]=n("strong",null,"Objectif :",-1)),d(" "+c(i.objective),1)])):m("",!0),e[11]||(e[11]=n("p",{class:"font-semibold"},"Inclus",-1)),n("ul",q,[n("li",null,[e[2]||(e[2]=n("strong",null,"Prix :",-1)),d(" "+c(r.displayMoney(r.monthlyPriceCents(i)))+" USD",1)]),n("li",null,[e[3]||(e[3]=n("strong",null,"Minutes incluses :",-1)),d(" "+c(i.included_minutes||"‚Äî")+" / mois",1)]),n("li",null,[e[4]||(e[4]=n("strong",null,"Concurrency :",-1)),d(" "+c(i.max_concurrency||i.concurrency||"‚Äî"),1)]),i.minutes_expiry_days?(l(),a("li",z,[e[5]||(e[5]=n("strong",null,"Expiration des minutes :",-1)),d(" "+c(i.minutes_expiry_days)+" jours",1)])):m("",!0),n("li",null,[e[6]||(e[6]=n("strong",null,"Priorit√© r√©seau :",-1)),d(" "+c(i.network_priority||"standard"),1)]),n("li",null,[e[7]||(e[7]=n("strong",null,"Soft limit :",-1)),d(" "+c(i.soft_limit_percent||"‚Äî")+"% ",1),e[8]||(e[8]=n("small",{class:"text-gray-500"},"Seuil d'alerte : d√©clenche avertissements et mesures d'att√©nuation avant facturation additionnelle.",-1))]),e[9]||(e[9]=n("li",null,[d("Throttling apr√®s d√©passement "),n("small",{class:"text-gray-500"},"Apr√®s d√©passement des minutes incluses, le d√©bit est r√©duit temporairement pour limiter les co√ªts.")],-1))]),e[12]||(e[12]=n("p",{class:"mt-3 font-semibold"},"Au-del√†",-1)),n("ul",F,[n("li",null,[e[10]||(e[10]=n("strong",null,"Facturation :",-1)),d(" "+c(r.displayMoney(i.per_min_cents||0))+" USD / minute",1)])]),e[13]||(e[13]=n("p",{class:"mt-3 font-semibold"},"Options",-1)),n("ul",T,[i.has_dedicated_number?(l(),a("li",U,"Num√©ro d√©di√© sur demande (add-on)")):m("",!0),i.has_extra_concurrency?(l(),a("li",I,"Concurrency suppl√©mentaire (add-on)")):m("",!0),i.has_dedicated_number?m("",!0):(l(),a("li",O,"Pas de num√©ro d√©di√©"))]),i.description?(l(),a("div",G,[n("ul",H,[(l(!0),a(f,null,g(r.formatDescription(i.description),(y,b)=>(l(),a("li",{key:b},c(y),1))),128))])])):m("",!0)]),n("div",J,[i.slug!=="free"?(l(),a("div",K,[n("button",{onClick:y=>r.subscribe(i),disabled:r.isPlanActive(i)||o.isLoading,class:h((i.slug==="pro"?"bg-white text-blue-700 px-4 py-2 rounded":"bg-blue-600 text-white px-4 py-2 rounded")+(r.isPlanActive(i)||o.isLoading?" opacity-50 cursor-not-allowed":""))},c(r.isPlanActive(i)?"Abonn√©":"S'abonner"),11,Q)])):(l(),a("span",R,"Plan gratuit"))])],2))),128))])])}const $=x(v,[["render",W]]);export{$ as default};
